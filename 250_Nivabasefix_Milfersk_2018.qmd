---
title: "Script 200_Nivabasefix_Milfersk_2018"
format: html
---

* Starting from the knowledge gotten from '200_Nivabase_Milfersk_2013-2022.qmd'  
    - Nivabasen has only fish specimens, lacking 3 Mysis relicta and 3 Zooplankton epilimnion   
    - Also, there are no BIOTA_SAMPLES_SPECIMENS records linking the specimens to samples  

## 1. Setup  

### For filenames  
```{r}

program_year <- "Milfersk_2018"
sampling_year <- 2018

```

### Labware data  

```{r}

# dat_lab <- readRDS("Data/100_dat_lab_Milfersk_2022_2023-06-22.rds")

```


### Packages and functions  
```{r}

library(niRvana)
library(dplyr)
library(purrr)
library(lubridate)
library(readxl)
library(ggplot2)
library(tidyr)
library(knitr)     # for kable
# library(fuzzyjoin)   # regex_full_join

source("../Milkys/991_Vannmiljo_snippets_functions.R")
source("../Milkys/992_Vannmiljo_Urban_fjord_functions.R")
source("../Milkys/994_Industry_data_functions.R")         # for add_coordinates()

knitr::opts_chunk$set(results = 'hold')

```


## 2.  Check existing NIVAbasen data    

### Projects  

```{r}

df_projects <- get_projects()   

# df_stations <- get_stations_from_project("MILFERSK", exact = FALSE)
df_stations1 <- get_stations_from_project("MILFERSK", exact = TRUE)
df_stations2 <- get_stations_from_project("MILFERSK 2021-2025", exact = TRUE)

df_stations <- bind_rows(df_stations1, df_stations2)

nrow(df_stations)

```

### Specimens      

* Data on specimens   
    - Has fish specimens  
    - Lacking 3 Mysis relicta and 3 Zooplankton epilimnion  
* Also, there are no BIOTA_SAMPLES_SPECIMENS records linking the specimens to samples  
    - We will deal with that later   

```{r}

# Code from script 0010  

# 
## BIOTA  
#

df_specimens <- get_specimens_from_stationdata(df_stations, years = sampling_year)
message("No. of specimens, biota: ", nrow(df_specimens))

df_specimens <- df_specimens %>% mutate(Year = year(DATE_CAUGHT))
nrow(df_specimens)

# debugonce(get_biota_chemistry)
# dat_nb_biota <- get_biota_chemistry(sampling_year, df_specimens, df_stations, report_samples = TRUE)
# FAILS because there are no links to BIOTA_SAMPLES_SPECIMENS  

df_specimens %>%
  left_join(df_stations, by = "STATION_ID") %>%
  mutate(St = paste(STATION_ID, STATION_CODE, STATION_NAME)) %>%
  xtabs(~St + DATE_CAUGHT, .)


#
## WATER  
## SEDIMENT
#
# No such samples this year


```

## 3. Add specimens  

### From Labware

```{r}

dat_lab <- readRDS("Data/100_dat_lab_Milfersk_2018_2023-06-28.rds")

table(dat_lab$SAMPLE_TYPE)
table(dat_lab$AQUAMONITOR_CODE)
table(dat_lab$AQUAMONITOR_NAME)
table(dat_lab$SPECIES)
table(dat_lab$SAMPLED_DATE)

xtabs(~AQUAMONITOR_NAME + SPECIES, dat_lab)  

dat_lab %>%
  filter(AQUAMONITOR_NAME == "Mjøsa zooplankton og Mysis") %>%
  arrange(TEXT_ID) %>%
  select(TEXT_ID, SAMPLED_DATE, DESCRIPTION, AQUAMONITOR_ID, AQUAMONITOR_CODE, SPECIES, TISSUE, BIOTA_SAMPLENO)

dat_lab %>%
  filter(AQUAMONITOR_NAME == "Mjøsa zooplankton og Mysis") %>%
  arrange(TEXT_ID) %>%
  select(TEXT_ID, SAMPLED_DATE, DESCRIPTION, AQUAMONITOR_ID, AQUAMONITOR_CODE, SPECIES, TISSUE, BIOTA_SAMPLENO)

```
### Create data to add 

* From script 100, we see that both zooplankton and Mysis are form STATION_ID 71087	(code 'M_ZM')  

```{r}

#
# Zooplankton epilimnion
#
df_taxon_zooplankton <- get_nivabase_data(
  "select * from NIVADATABASE.TAXONOMY_CODES where NAME like '%epilimn%'")
df_taxon_zooplankton$TAXONOMY_CODE_ID
# TAXONOMY_CODE_ID = 8941

#
# Mysis
#
df_taxon_mysis <- get_nivabase_data(
  "select * from NIVADATABASE.TAXONOMY_CODES where NAME like '%Mysis%'")
unique(df_taxon_mysis$TAXONOMY_CODE_ID)  
# TAXONOMY_CODE_ID = 14089


# make_sql_single_specimen 
# Needs columns 'DATE_CAUGHT', 'STATION_ID', 'TAXONOMY_CODE_ID', 'SPECIMEN_NO'  

data.frame(
  DATE_CAUGHT = ymd_hms("2018-08-01 00:00:00"),
  STATION_ID = 71087,
  TAXONOMY_CODE_ID = c(rep(8941, 3), rep(14089, 3)),
  SPECIMEN_NO = c(1,2,3,1,2,3)
)


```


