---
title: "0100_Data_from_excel_2020"
author: "DHJ"
date: "2022-11-11"
output: html_document
---

# Data 2020-21

No data in Vannmiljø for 2016-2019

In https://vannmiljo.miljodirektoratet.no/
"Jeg vil" => Søk i vannregistreringer og lokaliteter
Select records: 
  in menu "Forvaltningsaktivitet": select "Miljøgifter i en urban fjord"
  in menu "Prøvedato": select from 01/01/2016 to 31/12/2019
Returns no records ("Info! Søket gav ingen treff")

---------------------------------------------------------------

PARAMETERS
(see part 8)

NIVA:
- PFAS
- UV-chemicals (Octocrylene, benzophenone-3, ethylhexylmethoxycinnamate (plus UV-
    327, -328 and -329))
- Behentrimonium (ATAC-C20 and ATAC-C22)
- Biological effect parameters: Acetylcholinesterase (AChE)

NILU:
- metals
- PCBs, BDEs, brominated flame retardants and CPs (SCCP, MCCP)  
- alkylphenols and bisphenols
- siloxans
- PFRs (phosphorous flame retardants)
- antioxidant MB1
- M3T(Ph)
- Dechlorane plus and related compounds

IFE:
- stable isotopes of carbon and nitrogen

The concentrations of the following contaminants were expressed on a lipid weight basis: 
 PCBs and other organochlorine compounds, chlorinated paraffins, brominated flame retardants, 
 siloxanes (including M3T(Ph)), UV-filters and declorane plus (antioxidant MB1 was not 
 analysed in sufficient species for such evaluation in 2019). 
Behentrimonium was expressed at both wet weight and lipid weight basis
 when exploring correlations between contaminant concentrations and trophic position.

TABLES OF SUBSTANCES USED  
df_substances  
- contains substance names (used in Excel), Decription (long name), Chemspider and CAS   
- this equals appendix table B1 of the report  
df_substance_lookup  
- contains substance names (used in Excel), Group and Lab   
  

CHECKLIST FOR IMPORT - WHEN DATA ARE IN LABWARE_IMPORT + LABWARE_CHECK_SAMPLE, BUT NOT IN NIVADATABASE:  
1. Has STATION_CODE been set?  
2. Has sample number (e.g. 1-15) been set?  
  
If not 1 and/or 2, the lab has to make update!  



## 1. Setup  

```{r}

library(niRvana)
library(dplyr)
library(purrr)
library(lubridate)
library(readxl)
library(ggplot2)
library(tidyr)
# library(fuzzyjoin)   # regex_full_join

source("../Milkys/991_Vannmiljo_snippets_functions.R")
source("../Milkys/992_Vannmiljo_Urban_fjord_functions.R")
source("../Milkys/994_Industry_data_functions.R")         # for add_coordinates()
source("0110_Data_from_excel_2020-2021_functions.R")

knitr::opts_chunk$set(results = 'hold')

```


### Year  
```{r}

# year_sampling <- 2020

```


## 2. Lookup tables   

* Substance to substance group (Group) + Lab (NIVA / NILU etc)     
* Substance to substance name and CAS (used for populating METHOD_DEFINITIONS)     
* TISSUE_ID to TISSUE   
* SPECIE_ID to LATIN_NAME  

```{r}

# Look-up for substance groups (Group) + Lab (NIVA / NILU etc)    
lookup_substance_groups <- readxl::read_excel("Input_data/Lookup_files/992_Excel_substances.xlsx")

# Look-up for substance names + CAS numbers   
# - contains substance names (used in Excel), Decription (long name), Chemspider and CAS 
# - this equals appendix table B1 of the report
lookup_substance_names <- readRDS("Input_data/Lookup_files/Report2019_substancetable.rds") 

# From Nivabasen
# TISSUE_ID 

if (FALSE){
  # If we want to read from Nivabase
  lookup_tissues <- get_nivabase_data("select * from LABWARE.V_NIVA_TISSUE_TYPES", source = 'NIVABASE')
  lookup_species <- get_nivabase_data("select * from LABWARE.V_NIVA_SPECIES", source = 'NIVABASE')
}

lookup_tissues <- read.csv("Input_data/Lookup_files/lookup_tissues.csv") %>% select(-X)
lookup_species <- read.csv("Input_data/Lookup_files/lookup_species.csv") %>% select(-X)

```

## 3. Get METHOD_ID used before   

### Data already in NIvabase per 31.12.2022    

```{r}


dat_nivabase_bio <- read.table("Input_data/Nivabasen_data_2022/992_dat_biota_nivabase_2017-2021.txt", 
                               sep = "\t")
# Outdated! The Water samples are from before the water samples were tidied up in LIMS  
dat_nivabase_wat <- read.table("Input_data/Nivabasen_data_2022/992_dat_water_nivabase_2017-2021.txt", 
                               sep = "\t")
dat_nivabase_sed <- read.table("Input_data/Nivabasen_data_2022/992_dat_sediment_nivabase_2017-2021.txt", 
                               sep = "\t")

lookup_method_id <- bind_rows(
  dat_nivabase_bio,
  dat_nivabase_wat,
  dat_nivabase_sed
) %>%
  distinct(NAME, METHOD_ID, UNIT, LABORATORY, MATRIX)

table(addNA(lookup_method_id$MATRIX))

```

### Get all NILU methods   

```{r}

if (FALSE){

  # Read data from Nivabasen  
  # - ONE-TIME JOB (therefore wrapped in "if FALSE") - if already done, read the saved file
  # - gets data from Nivabase and save it   
  
  library(niRvana)
  
  lookup_method_id_allnilu <- get_nivabase_selection(
    columns = "NAME, METHOD_ID, UNIT, MATRIX, LABORATORY",
    table = "METHOD_DEFINITIONS", 
    selection_column = "LABORATORY",
    selection_values = "NILU", values_are_text = TRUE)
  
  # Write with tab as separator to avoid trouble with commas in names etc.  
  write.table(lookup_method_id_allnilu, "Data/0110_dat_nivabase_nilu_methods.txt",
              sep = "\t", row.names = FALSE)
  
}

lookup_method_id_allnilu <- read.table(
  "Data/0110_dat_nivabase_nilu_methods.txt", sep = "\t", header = TRUE)

table(addNA(lookup_method_id_allnilu$MATRIX))

```


## 4. Data 2020    

### a. NILU  

#### Read data and select rows    

```{r}

fn <- "Input_data/2020/NILU/004C NILU data stacked.txt"
df_nilu_2020_all <- read.delim(fn)  

if (FALSE){
  
# All data = including rows with no actual data in them
df_nilu_2020_all %>%
  distinct(Matrix, Label) %>%
  xtabs(~Matrix, .)
  
}

# Empty cells are not NA, they are empty character ("")
sel_rows <- df_nilu_2020_all$Data != "" | df_nilu_2020_all$LOQ  != ""

message("Fraction of rows with data: ", mean(sel_rows))  # 0.67

#
# Actual data
#
df_nilu_2020 <- df_nilu_2020_all[sel_rows,]

cat(nrow(df_nilu_2020), "rows\n")

```


#### Show matrix x number of substances  

```{r}

cat("Number of parameters: \n\n") 
df_nilu_2020 %>%              # View()
  distinct(Matrix, Label) %>%
  xtabs(~Matrix, .)

```

#### Check Unit in water and particles from filtered water  

- Particles (Partikler) are from filtering a certain amout of water, and are therefore given in per-liter unit  

```{r}

tab <- df_nilu_2020 %>%
  filter(Matrix %in% c("Partikler", "Renseanl. Vann")) %>%
  xtabs(~Label + Unit, .)

# tab

```

#### Value data  
```{r}

# xtabs(~(LOQ != "") + (Data.LOQ != "") + (Data != ""), df_nilu_2020)

xtabs(~(LOQ != "") + (Data.LOQ != "") + grepl("-", Data), df_nilu_2020)

```


#### Put in right format  
```{r}

df_nilu_2020_formatted <- df_nilu_2020 %>%
  mutate(
    VALUE = case_when(
      Data.LOQ != "" ~ as.numeric(sub(",", ".", Data.LOQ, fixed = TRUE)),
      Data.LOQ == "" ~ as.numeric(sub(",", ".", LOQ, fixed = TRUE))),
    FLAG1 = case_when(
      Data.LOQ != "" ~ as.character(NA),
      Data.LOQ == "" ~ "<")
  ) %>%
  rename(NAME_orig = Label)

df_check <- df_nilu_2020_formatted %>%
  filter(is.na(VALUE))

if (nrow(df_check) > 0){
  stop("There are rows with missing data for VALUE. Have a look at 'df_check'.")
}

df_nilu_2020_formatted <- df_nilu_2020_formatted %>%
  select(LIMS.NR, NAME_orig, VALUE, FLAG1, Unit)


```



## 5. Data 2021    

- NIVA, NILU And IFE in the same file   
- IFE data (isotopes) are in separate columns, `d13C[LIMS]` and `d15N[LIMS]`

#### Read data and select rows    

```{r}

fn <- "Input_data/2021/UrbanFjord_2021_concentrations_NIVAandNILU.xlsx"
df_urbanfjord_2021_all <- read_excel(fn)  

df_nilu_2021 <- df_urbanfjord_2021_all %>%
  filter(`LAB[Abbr]` %in% "NILU")

cat(nrow(df_nilu_2021), "rows\n")

```

#### Put in right format  
```{r}

table(df_nilu_2021$`Not analyzed`)

df_nilu_2021_formatted <- df_nilu_2021 %>%
  filter(is.na(`Not analyzed`)) %>%
  mutate(
    VALUE = case_when(
      !is.na(`Result>LOQ`) ~ `Result>LOQ`,
      is.na(`Result>LOQ`) ~ LOQ),
    FLAG1 = case_when(
      !is.na(`Result>LOQ`) ~ as.character(NA),
      is.na(`Result>LOQ`) ~ "<")
  ) %>%
  rename(
    LIMS.NR = LIMS,
    NAME_orig = Abbr,
    NAME_orig2 = `Compound name`,
    Unit = `Unit[LIMS]`,
    Matrix = `Matrix[LIMS]`) %>%
  select(LIMS.NR, NAME_orig, VALUE, FLAG1, Unit, Matrix)

df_check <- df_nilu_2021_formatted %>%
  filter(is.na(VALUE))

if (nrow(df_check) > 0){
  stop("Some data lack VALUE")
  # View(df_check)
}


```


## 6. Combine data  

### NILU data 2020-2021    

```{r}

df_nilu_01 <- bind_rows(
  df_nilu_2020_formatted %>% mutate(MYEAR = 2020),
  df_nilu_2021_formatted %>% mutate(MYEAR = 2021))

```


## 7. Add sample ID from Nivabasen  

### Download SAMPLE_IDs   

- ONE-TIME JOB (therefore wrapped in "if FALSE")
- gets data from Nivabase and save it   

```{r}

if (FALSE){
  
  # - ONE-TIME JOB (therefore wrapped in "if FALSE") - if already done, read the saved files (next chunk)
  
  library(niRvana)  
  
  # Check column names:
  # check2 <- get_nivabase_data("select * from NIVADATABASE.LABWARE_BSID where rownum < 100")  
  # check3 <- get_nivabase_data("select * from NIVADATABASE.LABWARE_WSID where rownum < 100")
  # check4 <- get_nivabase_data("select * from NIVADATABASE.LABWARE_SLICE_ID where rownum < 100")
  
  lookup_sampleid_bio <- get_nivabase_selection(
    columns = "LABWARE_TEXT_ID, BIOTA_SAMPLE_ID", 
    table = "LABWARE_BSID", selection_column = "LABWARE_TEXT_ID", 
    selection_values = unique(df_nilu_01$LIMS.NR), values_are_text = TRUE)

  lookup_sampleid_wat <- get_nivabase_selection(
    columns = "LABWARE_TEXT_ID, WATER_SAMPLE_ID", 
    table = "LABWARE_WSID", selection_column = "LABWARE_TEXT_ID", 
    selection_values = unique(df_nilu_01$LIMS.NR), values_are_text = TRUE)
  
  # THIS TABLE DOESN'T WORK! (the slice ID is completely wrong)  
  lookup_sampleid_sed <- get_nivabase_selection(
    columns = "*", 
    table = "LABWARE_SLICE_ID", selection_column = "LABWARE_TEXT_ID", 
    selection_values = unique(df_nilu_01$LIMS.NR), values_are_text = TRUE)
  
  # lookup_sampleid_sed <- get_nivabase_data(
  #   "select * from NIVADATABASE.LABWARE_SLICE_ID where LABWARE_TEXT_ID = 'NR-2020-08173'")
  
  
  write.csv(lookup_sampleid_bio, "Input_data/2021//lookup_sampleid_2020-21_bio.txt", row.names = FALSE)
  write.csv(lookup_sampleid_wat, "Input_data/2021//lookup_sampleid_2020-21_wat.txt", row.names = FALSE)
  write.csv(lookup_sampleid_sed, "Input_data/2021//lookup_sampleid_2020-21_sed.txt", row.names = FALSE)
  
}

```


###  Read SAMPLE_IDs  
```{r}

lookup_sampleid_bio <- read.csv("Input_data/2021//lookup_sampleid_2020-21_bio.txt")
lookup_sampleid_wat <- read.csv("Input_data/2021//lookup_sampleid_2020-21_wat.txt")
lookup_sampleid_sed <- read.csv("Input_data/2021//lookup_sampleid_2020-21_sed.txt")

```


### Add sample IDs to data  

```{r}
df_nilu_02 <- df_nilu_01 %>%
  left_join(lookup_sampleid_bio, by = c("LIMS.NR" = "LABWARE_TEXT_ID")) %>%
  left_join(lookup_sampleid_wat, by = c("LIMS.NR" = "LABWARE_TEXT_ID")) %>%
  left_join(lookup_sampleid_sed, by = c("LIMS.NR" = "LABWARE_TEXT_ID"))

```

### Check sample IDs  

```{r}

sel_bio <- !is.na(df_nilu_02$BIOTA_SAMPLE_ID)
sel_wat <- !is.na(df_nilu_02$WATER_SAMPLE_ID)
sel_sed <- !is.na(df_nilu_02$LABWARE_SLICEID_ID)

cat("Number of LIMS numbers found for biota, water and sediment: \n")
sum(sel_bio)
sum(sel_wat)
sum(sel_sed)

# df_nilu_02_bio <- df_nilu_02[sel_bio,]
# df_nilu_02_wat <- df_nilu_02[sel_wat,]
# df_nilu_02_sed <- df_nilu_02[sel_sed,]
# df_nilu_02_non <- df_nilu_02[!sel_bio & !sel_wat & !sel_sed,]  


```

## 8. Add bile samples  

*NOTE: If bile samples already have been added, skip to 9*

```{r}

### Moved to '0110_part8.R'  

```



## 9. Add BIOTA_SAMPLE_ID to bile samples in the data  

```{r}

df_gall_samples <- read.csv("Input_data/2020/df_bile_samples.csv")

df_nilu_03 <- df_nilu_02 %>%
  mutate(
    SAMPLE_NO = as.numeric(sub("galle", "", LIMS.NR))
    ) %>%
  left_join(
    df_gall_samples %>% select(SAMPLE_NO, SAMPLE_ID))

# Check:
# xtabs(~is.na(SAMPLE_ID) + is.na(BIOTA_SAMPLE_ID), df_nilu_03)

df_check <- with(df_nilu_03, sum(!is.na(SAMPLE_ID) & !is.na(BIOTA_SAMPLE_ID)))
if (df_check > 0){
  stop("Some samples have both SAMPLE_ID (from bile) and BIOTA_SAMPLE_ID")
}

sel <- !is.na(df_nilu_03$SAMPLE_ID); sum(sel)
df_nilu_03$BIOTA_SAMPLE_ID[sel] <- df_nilu_03$SAMPLE_ID[sel]

# Check:
# xtabs(~is.na(BIOTA_SAMPLE_ID) + is.na(WATER_SAMPLE_ID) + is.na(LABWARE_SLICEID_ID), df_nilu_03)

```
### Check IDs 

- each line should have one and exaclty one ID  

```{r}

id1 <- !is.na(df_nilu_03$BIOTA_SAMPLE_ID)
id2 <- !is.na(df_nilu_03$WATER_SAMPLE_ID)
id3 <- !is.na(df_nilu_03$LABWARE_SLICEID_ID)

table(id1, id2, id3)

```


## 10. Parameters, make initial lookup file     

### Make initial file for creating lookup file     
- do some simple changes to names  

```{r}

check_params <- df_nilu_03 %>%
  ungroup() %>%
  distinct(NAME_orig) %>%
  filter(
    !(grepl("^Sum", NAME_orig) & grepl("CB", NAME_orig))
  ) %>%
  mutate(
    Substance = case_when(
      grepl("^[0-9][0-9]\\s", NAME_orig) ~ toupper(substr(NAME_orig,5,6)),
      grepl("^[0-9][0-9][0-9]\\s", NAME_orig) ~ toupper(substr(NAME_orig,6,7)),
      grepl("^PBDE", NAME_orig) ~ sub("PBDE", "BDE", NAME_orig),
      TRUE ~ NAME_orig),
  ) %>%
  distinct(NAME_orig, Substance) %>%
  left_join(lookup_method_id, by = c("Substance" = "NAME"))

# Saved as 'lookup_params_2020-21_from_script0110.xlsx'


```

*AFTER manually creating 'lookup_params_2020-21.xlsx'*    

## 11. BIOTA  

### Create data 'df_nilu_03_bio_01'   
```{r}

df_temporary <- df_nilu_03 %>% 
  filter(!is.na(BIOTA_SAMPLE_ID))

cat("Biota data:", nrow(df_temporary), "rows \n")

df_temporary <- df_temporary %>% 
    filter(
    !(grepl("^Sum", NAME_orig) & grepl("CB", NAME_orig))
  )
cat("- exclude PCB sums:", nrow(df_temporary), "rows \n")

df_nilu_03_bio_01 <- df_temporary %>%
  filter(
    NAME_orig != "4-[2-(4-{[benzyl(triphenyl)-lambda~5~-phosphanyl]oxy}phenyl)-1,1,1,3,3,3-hexafluoropropan-2-yl]phenol"
  )

cat("- exclude '4-[2-(4-{[benzyl(triphenyl)-lambda~5~-phosphanyl]oxy}phenyl)-1,1,1,3,3,3-hexafluoropropan-2-yl]phenol' (too long name) \n")
cat("Final data: ", nrow(df_nilu_03_bio_01), "rows \n")

```

### Check 'Unit' from data  
```{r}


table(addNA(df_nilu_03_bio_01$Unit))

#
# Metals have ug/g and ug/L
#
table(subset(df_nilu_03_bio_01, Unit == "ug/g")$NAME_orig)
table(subset(df_nilu_03_bio_01, Unit == "ug/L")$NAME_orig)

```

### Set 'a': Add methods from methods file  

- Manual file for w.w. data  
- Added to data using 'NAME_modified' in the data, creating data set 'a'  

```{r}

lookup_methods_bio_excel <- readxl::read_excel(
  "Input_data/Lookup_files/lookup_params_2020-21.xlsx") %>%
  select(Label, METHOD_ID) %>%
  rename(NAME = Label)

if (FALSE){
  library(niRvana)
  lookup_methods_bio_1 <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID",
    "METHOD_DEFINITIONS", 
    "METHOD_ID", 
    lookup_methods_bio_excel$METHOD_ID)
  saveRDS(lookup_methods_bio_1, "Data/0110_lookup_methods_bio_1.rds")
}
lookup_methods_bio_1 <- readRDS("Data/0110_lookup_methods_bio_1.rds")

df_temporary <- df_nilu_03_bio_01 %>%
  ungroup() %>%
  mutate(
    NAME_modified = case_when(
      grepl("^[0-9][0-9]\\s", NAME_orig) ~ toupper(substr(NAME_orig,5,6)),
      grepl("^[0-9][0-9][0-9]\\s", NAME_orig) ~ toupper(substr(NAME_orig,6,7)),
      grepl("^PBDE", NAME_orig) ~ sub("PBDE", "BDE", NAME_orig),
      TRUE ~ NAME_orig),
  ) %>%
  left_join(lookup_methods_bio_1, by = c("NAME_modified" = "NAME"))

df_nilu_03_bio_a <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_bio_a_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_bio_a), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_bio_a_rest), "rows")

df_names_lacking_a <- df_nilu_03_bio_a_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_a), "names \n\n")

cat("Sum:", nrow(df_nilu_03_bio_a) + nrow(df_nilu_03_bio_a_rest), "rows \n\n")

cat("UNIT for rows with METHOD_ID: \n")
table(addNA(df_nilu_03_bio_a$UNIT))


```


### Set 'b': Add methods from search on NAME_modified    

- Based on the 'rest' from set a  

```{r}

if (FALSE){
  
  # Search for suitable methods using 'NAME_modified'  
  # - must be ww unit with NILU as lab  
  lookup_method_id_ww_1 <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
    "METHOD_DEFINITIONS", 
    "NAME", 
    df_names_lacking_a$NAME_modified, values_are_text = TRUE, 
    extra_sql = "and UNIT like '%w.w%' and LABORATORY = 'NILU'"
  )
  saveRDS(lookup_method_id_ww_1, "Data/0110_lookup_method_id_ww_1.rds")
}
lookup_method_id_ww_1 <- readRDS("Data/0110_lookup_method_id_ww_1.rds")

lookup_method_id_ww <- lookup_method_id_ww_1 %>%
  filter(MATRIX %in% "BIOTA")

# data
df_temporary <- df_nilu_03_bio_a_rest %>%
  select(-c(METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID)) %>%
  mutate(
    NAME_modified = case_when(
      grepl("^BDE", NAME_orig) ~ sub("BDE", "BDE-", NAME_orig),
      grepl("^CB", NAME_orig) ~ sub("CB", "PCB-", NAME_orig),
      TRUE ~ NAME_orig),
  ) %>%
  left_join(lookup_method_id_ww, by = c("NAME_modified" = "NAME"))

df_nilu_03_bio_b <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_bio_b_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_bio_b), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_bio_b_rest), "rows")

df_names_lacking_b <- df_nilu_03_bio_b_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_b), "names \n\n")
cat("Sum:", nrow(df_nilu_03_bio_b) + nrow(df_nilu_03_bio_b_rest), "rows")


if (F){
  writexl::write_xlsx(
    list(df_names_lacking_b, lookup_method_id_ww),
    "Data/0110_df_names_lacking_b.xlsx")
}

```

### Add methods    

#### Add parameter names from edited file  

```{r}

df_names_edited <- readxl::read_excel("Data/0110_df_names_edited.xlsx")

df_nilu_03_bio_c <- df_nilu_03_bio_b_rest %>%
  select(-UNIT) %>%
  left_join(df_names_edited %>% select(-NAME_orig, -MATRIX), by = "NAME_modified")

table(addNA(df_nilu_03_bio_c$UNIT))

```


#### Make data for adding to METHOD_DEFINITIONS   
```{r}

df_methods_to_add_bio <- df_nilu_03_bio_c %>%
  filter(is.na(UNIT)) %>%
  distinct(NAME_orig) %>%
  rename(NAME = NAME_orig)

df_methods_to_add_bio$UNIT <- "ng/g w.w."
df_methods_to_add_bio$LABORATORY <- "NILU"
df_methods_to_add_bio$MATRIX <- "BIOTA"
df_methods_to_add_bio$MATRIX_ID <- 1
df_methods_to_add_bio$CAS <- NA
df_methods_to_add_bio$METHOD_REF <- NA

```

#### Make SQLs    

PASTE INTO SQL DEVELOPER TO ADD THE RECORDS    

- Need NAME, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID  
Note to DHJ: use "SQL developer (latest version)" from desktop. Don't use the start menu.  
- remember `commit;` after running the insert sentences  

```{r}

sql_list <- 1:nrow(df_methods_to_add_bio) %>% 
  map_chr(make_sql_methods, data = df_methods_to_add_bio)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")  
writeLines(sql, "clipboard")  # copies SQLs to clipboard - go to SQL Developer and paste

cat("Number of SQLs: \n")
length(sql_list)  # 9


cat("\nSample of SQLs: \n")
sql_list[1:3]

```

### Get the records we just added   

- Also checks that the number of new records is the same as no. of SQLs  
- Remember to **commit** in SQL developer first  

```{r}

if (FALSE){
  
  # day_for_adding_records <- substr(lubridate::now(tzone = "UTC"), 1, 10)
  day_for_adding_records <- "2023-01-25"
  
  biota_methods_added_to_database <- niRvana::get_nivabase_data(paste(
    "select NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID",
    "from NIVADATABASE.METHOD_DEFINITIONS",
    "where TRUNC(ENTERED_DATE) = TO_DATE(", sQuote(day_for_adding_records), ", 'yyyy-mm-dd')", 
    " and ENTERED_BY = 'DHJ'")
  )
  
  cat("Number of retrieved records: ")
  n_records2 <- nrow(biota_methods_added_to_database)
  n_records2
  
  write.table(biota_methods_added_to_database, "Data/0110_biota_methods_added_to_database.txt", 
              sep = "\t", row.names = FALSE)
  
  library(niRvana)
  
  #
  # lookup_extra1 below
  #
  lookup_extra1 <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
    "METHOD_DEFINITIONS", 
    "NAME", 
    c("4-tert-Octylphenol", "4-Nonylphenol"), values_are_text = TRUE, 
    extra_sql = "and UNIT like '%w.w%' and LABORATORY = 'NILU'"
  )
  dput(lookup_extra1)
  
  
  #
  # lookup_extra2 below
  #
  # insert into NIVADATABASE.METHOD_DEFINITIONS (NAME, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID)\nvalues ('4,4-bis-F', 'ng/g w.w.', 'NILU', NULL, 'BIOTA', NULL, 1);
  # insert into NIVADATABASE.METHOD_DEFINITIONS (NAME, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID)\nvalues ('2,4-bis-F', 'ng/g w.w.', 'NILU', NULL, 'BIOTA', NULL, 1);
  # insert into NIVADATABASE.METHOD_DEFINITIONS (NAME, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID)\nvalues ('2,2-bis-F', 'ng/g w.w.', 'NILU', NULL, 'BIOTA', NULL, 1);
  
    day_for_adding_records <- substr(lubridate::now(tzone = "UTC"), 1, 10)
  day_for_adding_records <- "2023-01-27"
  
  biota_methods_added_to_database_2 <- niRvana::get_nivabase_data(paste(
    "select NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID",
    "from NIVADATABASE.METHOD_DEFINITIONS",
    "where TRUNC(ENTERED_DATE) = TO_DATE(", sQuote(day_for_adding_records), ", 'yyyy-mm-dd')", 
    " and ENTERED_BY = 'DHJ'")
  )
  dput(biota_methods_added_to_database_2)
  
  
}

biota_methods_added_to_database_1 <- read.table("Data/0110_biota_methods_added_to_database.txt", header = TRUE)


```

#### Add some extra   
```{r}


lookup_extra1 <- structure(
  list(
    NAME = c("4-Nonylphenol", "4-tert-Octylphenol"), 
    METHOD_ID = c(32390, 32454), UNIT = c("ng/g w.w.", "ng/g w.w."), LABORATORY = c("NILU", "NILU"), 
    METHOD_REF = c("LC-QToF", "LC-QToF"), MATRIX = c("BIOTA", "BIOTA"), MATRIX_ID = c(1, 1)), 
  class = "data.frame", row.names = c(NA, -2L)
)

# See 'Also added:' above:  
lookup_extra2 <- structure(
  list(
    NAME = c("4,4-bis-F", "2,4-bis-F", "2,2-bis-F"), 
    METHOD_ID = c(38086, 38087, 38088), UNIT = c("ng/g w.w.", "ng/g w.w.", "ng/g w.w."), 
    LABORATORY = c("NILU", "NILU", "NILU"), METHOD_REF = c(NA_character_, NA_character_, NA_character_), 
    MATRIX = c("BIOTA", "BIOTA", "BIOTA"), CAS = c(NA_character_, NA_character_, NA_character_), 
    MATRIX_ID = c(1, 1, 1)), 
  class = "data.frame", row.names = c(NA, -3L)
)

biota_methods_added_to_database <- bind_rows(biota_methods_added_to_database_1, lookup_extra1, lookup_extra2)


```


### Set 'c': Added methods are added to data  

- Based on the 'rest' from set b  
- Using NAME_modified   

```{r}

# data
df_temporary <- df_nilu_03_bio_b_rest %>%
  select(-c(METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID)) %>%
  filter(
    NAME_orig != "4-[2-(4-{[benzyl(triphenyl)-lambda~5~-phosphanyl]oxy}phenyl)-1,1,1,3,3,3-hexafluoropropan-2-yl]phenol"
  ) %>%
  mutate(
    NAME_modified = case_when(
      NAME_orig %in% "4-tert-octylphenol" ~ "4-tert-Octylphenol",
      NAME_orig %in% "4-nonylphenol" ~ "4-Nonylphenol",
      TRUE ~ NAME_orig )
  ) %>%
  left_join(biota_methods_added_to_database, by = c("NAME_modified" = "NAME"))

df_nilu_03_bio_c <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_bio_c_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_bio_c), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_bio_c_rest), "rows")

df_names_lacking_c <- df_nilu_03_bio_c_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_c), "names \n\n")
cat("Sum:", nrow(df_nilu_03_bio_c) + nrow(df_nilu_03_bio_c_rest), "rows")


if (F){
  writexl::write_xlsx(
    list(df_names_lacking_b, lookup_method_id_ww),
    "Data/0110_df_names_lacking_b.xlsx")
}

```

### Combine a, b and c   

```{r}

df_nilu_03_bio_02 <- bind_rows(
  df_nilu_03_bio_a,
  df_nilu_03_bio_b,
  df_nilu_03_bio_c
) %>%
  select(-SAMPLE_ID) %>%
  rename(SAMPLE_ID = BIOTA_SAMPLE_ID)

if (nrow(df_nilu_03_bio_01) != nrow(df_nilu_03_bio_02)){
  stop("Row numnbers should be the same")
}

if (sum(is.na(df_nilu_03_bio_02$SAMPLE_ID)) > 0){
  stop("Some SAMPLE_ID are lacking!")
}

# df <- df_nilu_03_bio_02 %>%
#   select(SAMPLE_ID, METHOD_ID, VALUE, FLAG1)
# apply(is.na(df), 2, mean)

```
### Save lookup for parameter names  

```{r}

df_names_biota <- df_nilu_03_bio_02 %>%
  distinct(NAME_orig, NAME_modified, METHOD_ID)

if (FALSE){
  
  check <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
    "METHOD_DEFINITIONS", 
    "METHOD_ID", 
    unique(df_names_biota$METHOD_ID)
  )
  
  check2 <- df_names_biota %>%
    full_join(check %>% select(METHOD_ID, NAME))  
  
  check3 <- check2 %>%
    filter(NAME_modified != NAME)
  
  if (nrow(check3) > 0){
    stop("Some NAME are different form NAME_modified")
  }
  # there were none
  
}

# Save
# saveRDS(df_names_biota, "Data/0110_df_names_biota.rds")

```


## 12. Biota, IFE data  

- Isotopes + percentage of C and N  

### 2020  

#### Read and select rows    

```{r}

fn <- "Input_data/2020/IFE/010 LIMS numbers and data IFE.txt"

# Check how data looks like
# readLines(fn, 2)

df_ife_2020_all <- read.delim(fn)  

# Empty cells are not NA, they are empty character ("")
sel_rows <- df_ife_2020_all$d13CVPDB != "" 

message("Fraction of rows with data: ", mean(sel_rows))  # 0.67

# View(df_ife_2020_all[!sel_rows,])

#
# Actual data
#
df_ife_2020 <- df_ife_2020_all[sel_rows,]

cat(nrow(df_ife_2020), "rows\n")

```


#### Lines with no data has some pooled sample info   

- But this should already be in the database anyways  

```{r}

df_ife_2020_all[!sel_rows,] %>%
  filter(Column.2 != "") %>%
  select(Column.2, Column.3, Column.4, Individual)

```


#### Fix data   

- character (with comma decimal) to numeric 

```{r}

# df_ife_2020 %>% names() %>% dput()

vars <- c("d13CVPDB", "d15NAIR", "W.C", 
          "W.N", "C.N.W.Ratio", "Trophic.level", "Average.SD.ARU")

for (var in vars){
  df_ife_2020[[var]] <- as.numeric(gsub(",", ".", df_ife_2020[[var]]))
}


```


#### Check existing parameters and samples    

```{r}

# Will be used later
lookup_ife <- structure(
  list(
    NAME = c("C/N", "W% C", "W% N", "d13C", "d15N"), 
    METHOD_ID = c(29292, 29290, 29291, 29269, 29289), 
    UNIT = c(NA, "%", "%", "‰", "‰"), 
    LABORATORY = c("IFE", "IFE", "IFE", "IFE", "IFE"), 
    METHOD_REF = c(NA_character_, NA_character_, NA_character_, NA_character_, NA_character_), 
    MATRIX = c(NA_character_, NA_character_, NA_character_, NA_character_, NA_character_), 
    MATRIX_ID = c(1,1, 1, 1, 1)), 
  row.names = 1:5, class = "data.frame")

```


#### Put in right format
```{r}

df_ife_2020_formatted <- df_ife_2020 %>%
  rename(LIMS.NR = LIMS_NR,
         d13C = d13CVPDB,
         d15N = d15NAIR,
         `W% C` = W.C,
         `W% N` = W.N,
         `C/N` = C.N.W.Ratio) %>% #names()
  select(LIMS.NR, d13C:`C/N`) %>%
  pivot_longer(cols = -LIMS.NR, names_to = "NAME_orig", values_to = "VALUE") %>%
  mutate(FLAG1 = NA_character_) %>%
  left_join(lookup_ife, by = c("NAME_orig" = "NAME"))

check_na(df_ife_2020_formatted, "METHOD_ID")
check_na(df_ife_2020_formatted, "LIMS.NR")
check_na(df_ife_2020_formatted, "VALUE")

# table(df_ife_2020_formatted$LIMS.NR)

```

### 2021

#### Read data  

- LIMS numbers are for liver  

```{r}

fn <- "Input_data/2021/UrbanFjord_2021_SampleOverview.xlsx"  

dat_sample <- read_excel(fn) 

df_ife_2021_formatted <- dat_sample %>%
  filter(!is.na(`d13C`)) %>%
  select(`LIMS-NO`, `d13C`:`W% N`) %>%
  rename(LIMS.NR = `LIMS-NO`) %>% 
  pivot_longer(cols = -LIMS.NR, names_to = "NAME_orig", values_to = "VALUE") %>%
  mutate(FLAG1 = NA_character_) %>%
  left_join(lookup_ife, by = c("NAME_orig" = "NAME"))

check_na(df_ife_2021_formatted, "METHOD_ID")
check_na(df_ife_2021_formatted, "LIMS.NR")
check_na(df_ife_2021_formatted, "VALUE")

```


### Combine 2020 + 2021  

```{r}

df_ife <- bind_rows(df_ife_2020_formatted, df_ife_2021_formatted)  

```

### Need extra sample IDs (fro cod muscle)   
```{r}

if (FALSE){
  
  library(niRvana)  
  
  # Check column names:
  # check2 <- get_nivabase_data("select * from NIVADATABASE.LABWARE_BSID where rownum < 100")  
  # check3 <- get_nivabase_data("select * from NIVADATABASE.LABWARE_WSID where rownum < 100")
  # check4 <- get_nivabase_data("select * from NIVADATABASE.LABWARE_SLICE_ID where rownum < 100")
  
  lookup_sampleid_extra <- get_nivabase_selection(
    columns = "LABWARE_TEXT_ID, BIOTA_SAMPLE_ID", 
    table = "LABWARE_BSID", selection_column = "LABWARE_TEXT_ID", 
    selection_values = c("NR-2021-07953", "NR-2021-07954", "NR-2021-07955"), values_are_text = TRUE)
  
}

lookup_sampleid_extra <- structure(list(
  LABWARE_TEXT_ID = c("NR-2021-07953", "NR-2021-07954", "NR-2021-07955"), 
  BIOTA_SAMPLE_ID = c(246857, 246858, 246859)), class = "data.frame", row.names = c(NA, -3L))

```


### Add SAMPLE_ID  

```{r}

df_ife <- df_ife %>%
  left_join(
    bind_rows(
      lookup_sampleid_bio, 
      lookup_sampleid_extra),
    by = c("LIMS.NR" = "LABWARE_TEXT_ID")) %>%
  rename(SAMPLE_ID = BIOTA_SAMPLE_ID)

check_na(df_ife, "SAMPLE_ID")
# check_na(df_ife, "SAMPLE_ID", F) %>% View

```


## 13. Biota, combine NILU and IFE    

```{r}

df_combined_data <-bind_rows(
  df_nilu_03_bio_02,
  df_ife)

check_na(df_combined_data, "SAMPLE_ID")


check_na(df_ife, "SAMPLE_ID")
check_na(df_ife, "METHOD_ID")
check_na(df_ife, "VALUE")


```



## 14. Biota, add measurements to Nivabasen  


### Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS  
```{r}

sql_list <- 1:nrow(df_combined_data) %>% 
  map_chr(make_sql_chemistry_values, 
          data = df_combined_data)
length(sql_list) # 7957

i <- 1:length(sql_list)
sql <- paste(sql_list[i], collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard-4096")   # copies SQLs to clipboard - go to SQL Developer and paste
                                    # "clipboard-1024" instead of "clipboard": increases avaliable
                                      #    for the clipboard
cat("Length of sql_list:", 
    length(sql_list), "\n\n")

cat("Two first and two last SQLs: \n\n")
head(sql_list, 2)
cat("-------------------------------------\n")
tail(sql_list, 2)

#
# See 'Urbanfjord_biota_measurements_5sql' in SQL Developer
# C:\Users\DHJ\AppData\Roaming\SQL Developer
#

```


## 15. WATER        

### Existing data     

#### Get data from Nivabase     

```{r}

table(dat_nivabase_wat$STATION_ID)

library(niRvana)

df_projects <- get_projects()   

df_stations <- get_stations_from_project("Urban fjord", ignore.case = FALSE)
# Urban fjord (PROJECT_ID: 8551)

cat("Number of stations:", nrow(df_stations), "\n")

#
## Water samples  
#

df_samples_water <- get_nivabase_selection(
  "*",
  "WATER_SAMPLES",
  "STATION_ID",
  df_stations$STATION_ID
)
message("No. of samples, water: ", nrow(df_samples_water))

# Adds "SAMPLE_TYPE", "SAMPLE_NUMBER", "DESCRIPTION" and "n_labware" from Labware

df_samples_water <- df_samples_water %>%
  mutate(Year = year(SAMPLE_DATE)) %>%
  left_join(df_stations %>% select(STATION_ID, STATION_CODE, STATION_NAME))

xtabs(~paste(STATION_ID, STATION_CODE, STATION_NAME) + Year, 
      df_samples_water %>% filter(Year %in% 2019:2021))

```

#### Get chemistry  

```{r}

# debugonce(get_water_chemistry_from_stations)
dat_water <- get_water_chemistry_from_stations(unique(df_samples_water$STATION_ID), 2017:2021)


```

#### Tabulate chemistry  
```{r}

xtabs(~paste(STATION_ID, STATION_CODE, STATION_NAME) + Year, 
      dat_water)

```

#### Check one 2021 sample  

```{r}

dat_water %>%
  filter(STATION_CODE %in% "ALN 125" & Year == 2021) %>%
  arrange(NAME) %>%
  select(NAME, UNIT, VALUE, FLAG1)

```

#### Check one 2020 sample    

```{r}

dat_water %>%
  filter(STATION_CODE %in% c("ALN 125", "ALN 125xp") & Year == 2020) %>%
  filter(grepl("EtFOSAA", NAME)) %>%
  arrange(NAME) %>%
  select(STATION_CODE, NAME, UNIT, VALUE, FLAG1, METHOD_ID)

```
#### Check parameters  

```{r}

method_check <- get_nivabase_selection(
  # "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
  "*", 
  "METHOD_DEFINITIONS", 
  "METHOD_ID", 
  c(31455, 38511)
  )


```




### Get NILU 2020 raw data    

* Water water phase   
    - "Tilf.overvann" (storm water, 2 stations) + "Renseanl. Vann" (Bekkelaget WWTF)   
* Water particle phase  
    - "Partikler" (storm water, 2 stations)   
* Sediment  
    - "Renseanl. Slam" (Bekkelaget WWTF)    

#### Select rows, set STATION_ID  
```{r}

# table(df_nilu_2020$Matrix)

if (FALSE)
  df_nilu_2020 %>%
    filter(Matrix %in% c("Partikler", "Renseanl. Slam", "Renseanl. Vann", "Tilf.overvann")) %>%
    xtabs(~Rapp.frist.01.02.21...Prøvested + Matrix, .)  

#                                              Year
# paste(STATION_ID, STATION_CODE, STATION_NAME) 2017 2018 2019 2020 2021
    # 69644 BRA Bekkelaget Renseanlegg            66    2   78   80  560
    # 73472 ALNA River ALNA River vann             0    0    0    0  374
    # 73979 ALN 136 Alna, ALN 136                 66    1   79   78    0
    # 73980 ALN 125 Alna, ALN 125                 66    1   79   78  188
    
df_nilu_water_2020_1 <- df_nilu_2020 %>%
  filter(Matrix %in% c("Partikler", "Renseanl. Vann", "Tilf.overvann")) %>%
  rename(Station = Rapp.frist.01.02.21...Prøvested) %>%
  mutate(
    # STATION_ID = case_when(
    #   Station %in% "Alna 125 X" ~ 73980,
    #   Station %in% "Alna 136 X" ~ 73979,
    #   Station %in% "Bekkelaget" ~ 69644),
    Fraction = case_when(
      Matrix %in% "Partikler" ~ "Particle fraction",
      TRUE ~ "Water fraction"),
    Year = 2020
  ) 

# xtabs(~paste(STATION_ID, Station) + Year, df_nilu_water_2020)  
xtabs(~Station + Year, df_nilu_water_2020)  

```

#### Fix value + flag  
```{r}

df_nilu_water_2020_2 <- df_nilu_water_2020_1 %>%
  mutate(
    VALUE = case_when(
      Data.LOQ != "" ~ as.numeric(sub(",", ".", Data.LOQ, fixed = TRUE)),
      Data.LOQ == "" ~ as.numeric(sub(",", ".", LOQ, fixed = TRUE))),
    FLAG1 = case_when(
      Data.LOQ != "" ~ as.character(NA),
      Data.LOQ == "" ~ "<")
  ) %>%
  rename(NAME_orig = Label)

df_check <- df_nilu_water_2020_2 %>%
  filter(is.na(VALUE))

if (nrow(df_check) > 0){
  stop("There are rows with missing data for VALUE. Have a look at 'df_check'.")
}

df_nilu_water_2020_2 <- df_nilu_water_2020_2 %>%
  select(LIMS.NR, Station,  Year, Fraction, NAME_orig, VALUE, FLAG1, Unit)  


```

#### Check  
```{r}

xtabs(~ Station + Fraction, df_nilu_water_2020_2)

```


### Get NILU 2021 raw data    

* Water water phase   
    - "Tilf.overvann" (storm water, 2 stations) + "Renseanl. Vann" (Bekkelaget WWTF)   
* Water particle phase  
    - "Partikler" (storm water, 2 stations)   
* Sediment  
    - "Renseanl. Slam" (Bekkelaget WWTF)    

#### Select rows, set STATION_ID  
```{r}

# table(df_nilu_2021$`Matrix[LIMS]`) 
# table(df_nilu_2021$`Sample Markings[LIMS]`) 
# table(df_nilu_2021$`Sample[LIMS]`) 
# table(df_nilu_2021$`Sample type[LIMS]`) %>% names %>% dput

if (FALSE)
  df_nilu_2021 %>%
    filter(Matrix %in% c("Partikler", "Renseanl. Slam", "Renseanl. Vann", "Tilf.overvann")) %>%
    xtabs(~Rapp.frist.01.02.21...Prøvested + Matrix, .)  

#                                              Year
# paste(STATION_ID, STATION_CODE, STATION_NAME) 2017 2018 2019 2020 2021
    # 69644 BRA Bekkelaget Renseanlegg            66    2   78   80  560
    # 73472 ALNA River ALNA River vann             0    0    0    0  374
    # 73979 ALN 136 Alna, ALN 136                 66    1   79   78    0
    # 73980 ALN 125 Alna, ALN 125                 66    1   79   78  188

 matrices <- c("Alna River Diss.", "Alna River Part.", 
               "Stormwater Diss.", "Stormwater Part.", 
               "WWTP Diss.", "WWTP Part.")
    

df_nilu_water_2021_1 <- df_nilu_2021 %>%
  rename(
    Matrix = `Matrix[LIMS]`,
    Station = `Sample[LIMS]`) %>%
  filter(Matrix %in% c("Part", "Vann")) %>%
  mutate(
    Fraction = case_when(
      Matrix %in% "Part" ~ "Particle fraction",
      Matrix %in% "Vann" ~ "Water fraction"),
    Year = 2021
  ) 

xtabs(~Station + Year, df_nilu_water_2021_1)  

```

#### Fix value + flag  
```{r}

df_nilu_water_2021_2 <- df_nilu_water_2021_1 %>%
  mutate(
    VALUE = case_when(
      !is.na(`Result>LOQ`) ~ `Result>LOQ`,
      is.na(`Result>LOQ`) ~ LOQ),
    FLAG1 = case_when(
      !is.na(`Result>LOQ`) ~ as.character(NA),
      is.na(`Result>LOQ`) == "" ~ "<")
  ) %>%
  rename(
    LIMS.NR = LIMS,
    NAME_orig = Abbr,
    NAME_orig2 = `Compound name`,
    Unit = `Unit[LIMS]`)

sel_delete <- is.na(df_nilu_water_2021_2$VALUE) & 
  df_nilu_water_2021_2$NAME_orig %in% c("Sum-HepCB", "Sum-PenCB", "Sum-TriCB", "TBBPA")
sum(sel_delete)

df_nilu_water_2021_2 <- df_nilu_water_2021_2[!sel_delete,]

df_check <- df_nilu_water_2021_2 %>%
  filter(is.na(VALUE))

if (nrow(df_check) > 0){
  stop("There are rows with missing data for VALUE. Have a look at 'df_check'.")
}

df_nilu_water_2021_2 <- df_nilu_water_2021_2 %>%
  select(LIMS.NR, Station, Year, Fraction, NAME_orig, VALUE, FLAG1, Unit)  


```

#### Check  
```{r}

xtabs(~Station + Fraction, df_nilu_water_2021_2)

```


### Combine NILU 2020 + 2021  

```{r}

df_nilu_water_01 <- bind_rows(
  df_nilu_water_2020_2, 
  df_nilu_water_2021_2
)

```

#### Remove some rows  

```{r}

cat("Water data:", nrow(df_nilu_water_01), "rows \n")

df_nilu_water_02 <- df_nilu_water_01 %>%
   filter(
    !(grepl("^Sum", NAME_orig) & grepl("CB", NAME_orig))
  )

cat("- exclude PCB sums:", nrow(df_nilu_water_02), "rows \n")


df_nilu_water_03 <- df_nilu_water_02 %>%
  filter(
    NAME_orig != "4-[2-(4-{[benzyl(triphenyl)-lambda~5~-phosphanyl]oxy}phenyl)-1,1,1,3,3,3-hexafluoropropan-2-yl]phenol"
  )

cat("- exclude '4-[2-(4-{[benzyl(triphenyl)-lambda~5~-phosphanyl]oxy}phenyl)-1,1,1,3,3,3-hexafluoropropan-2-yl]phenol' (too long name) \n")
cat("Final data: ", nrow(df_nilu_water_03), "rows \n")


```

#### Check unit  
```{r}

table(df_nilu_water_03$Unit)

```
#### Check unit ug/L  
```{r}

table(subset(df_nilu_water_03, Unit == "ug/L")$NAME_orig)

```



### Get water sample ID    

* Based on LIMS.NR in excel for 2020-2021   

```{r}

lookup_sampleid_wat <- get_nivabase_selection(
  columns = "LABWARE_TEXT_ID, WATER_SAMPLE_ID", 
  table = "LABWARE_WSID", selection_column = "LABWARE_TEXT_ID", 
  selection_values = unique(df_nilu_water_03$LIMS.NR), values_are_text = TRUE)

```

#### Check that we have all IDs we need   

```{r}

check <- unique(df_nilu_water_03$LIMS.NR) %in% lookup_sampleid_wat$LABWARE_TEXT_ID

if (sum(is.na(check)) > 0)
  stop("Cannot find WATER_SAMPLE_ID for some LIMS.NR")

```

### Add WATER_SAMPLE_ID  

```{r}

dat_water <- df_nilu_water_03 %>%
  left_join(lookup_sampleid_wat, by = c("LIMS.NR" = "LABWARE_TEXT_ID"))  

```


#### Check WATER_SAMPLE_ID    

```{r}

df1 <- lookup_sampleid_wat %>%
  count(WATER_SAMPLE_ID, name = "lookup")
df2 <- dat_water %>%
  count(WATER_SAMPLE_ID, Year, name = "data")

df_check <- full_join(df1, df2, by = "WATER_SAMPLE_ID")

check <- df_check %>% 
  filter(Year %in% 2020:2021) %>%
  pull(WATER_SAMPLE_ID)

if (sum(is.na(check)) > 0)
  stop("Some data are lacking WATER_SAMPLE_ID")

df_check


```
### Split in water and particle fraction  
```{r}

dat_water_w_1 <- dat_water %>% filter(Fraction %in% "Water fraction")
dat_water_p_1 <- dat_water %>% filter(Fraction %in% "Particle fraction")

nrow(dat_water_w_1)
nrow(dat_water_p_1)

```


### Parameter names  

#### Lookup for biota names  

- Made from biota data, above    

```{r}

lookup_names_biota <- readRDS("Data/0110_df_names_biota.rds")

```

#### Existing names for water, water phase  
```{r}

df_temporary <- get_nivabase_selection(
  "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
  "METHOD_DEFINITIONS", 
  "NAME", 
  lookup_names_biota$NAME_modified, values_are_text = TRUE, 
  extra_sql = "and LABORATORY = 'NILU'"
  )

# table(df_temporary$UNIT)

nrow(df_temporary)

df_methods_ww_1 <- df_temporary %>%
  filter(UNIT %in% c("µg/l", "ng/l", "ng/L"))

nrow(df_methods_ww_1)

```
#### Check methods with same name  

```{r}

df_check <- df_methods_ww_1 %>%
  arrange(NAME, UNIT, METHOD_ID) %>%
  add_count(NAME) %>%
  filter(n > 1)

```

#### Filter  
```{r}

df_methods_ww_2 <- df_methods_ww_1 %>%
  arrange(NAME, UNIT, METHOD_ID) %>%
  group_by(NAME) %>%
  mutate(METHOD_ID_max = max(METHOD_ID)) %>%
  filter(METHOD_ID == METHOD_ID_max)


```


### Set 'a': Water fraction   

- Add methods from Nivabase methods    

#### Add to water fraction data  

```{r}

# Add NAME_modified  
dat_water_w_2 <- dat_water_w_1 %>%
  left_join(lookup_names_biota %>% select(NAME_orig, NAME_modified))

# Fix NAME_modified for metals
# dat_water_w_2 %>% filter(is.na(NAME_modified)) %>% count(NAME_orig) %>% pull(NAME_orig) %>% dput()

metals_sentencecase <- c("Ag", "As", "Cd", "Cr", "Cu", "Fe", "Ni", "Pb", "Sb", "Zn", "Hg") 
metals_uppercase <- toupper(metals_sentencecase)
dat_water_w_2 <- dat_water_w_2 %>%
  mutate(
    NAME_modified = case_when(
      NAME_orig %in% metals_sentencecase ~ NAME_orig,
      NAME_modified %in% metals_uppercase ~ stringr::str_to_sentence(NAME_modified),
      TRUE ~ NAME_modified)
  )

dat_water_w_3 <- dat_water_w_2 %>%
  left_join(df_methods_ww_2, by = c("NAME_modified" = "NAME"))  

```

#### Data set   

```{r}

dat_water_a <- dat_water_w_3 %>%
  filter(!is.na(METHOD_ID))

dat_water_a_rest <- dat_water_w_3 %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(dat_water_a), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(dat_water_a_rest), "rows")

df_names_lacking_a <- dat_water_a_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_a), "names \n\n")

cat("Sum:", nrow(dat_water_a) + nrow(dat_water_a_rest), "rows \n\n")

cat("UNIT for rows with METHOD_ID: \n")
table(addNA(dat_water_a$UNIT))

```

#### Crosstable for unit  
```{r}

dat_water_a %>%
  count(Unit, UNIT)

```

#### Check lackin

### Set 'b' - Water fraction     

#### Look for metals     

* Written as 'Cu' (sentence case), one with and one without METHOD_REF  

```{r}

df_temporary <- get_nivabase_selection(
  "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
  "METHOD_DEFINITIONS", 
  "NAME", 
  c("Cu", "CU"), values_are_text = TRUE, 
  extra_sql = "and LABORATORY = 'NILU'"
  )

# table(df_temporary$UNIT)

nrow(df_temporary)

df_temporary2 <- df_temporary %>%
  filter(UNIT %in% c("µg/l", "µg/L", "ng/l", "ng/L"))

nrow(df_temporary2)

```

#### Look for PCBs    

* Written as 'PCB-118' (upper case with hyphen), one with and one without METHOD_REF  

```{r}

df_temporary <- get_nivabase_selection(
  "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
  "METHOD_DEFINITIONS", 
  "NAME", 
  c("CB118", "PCB118", "CB-118", "PCB-118", "BDE99", "BDE-99", "PBDE99", "PBDE-99"),
  values_are_text = TRUE, 
  extra_sql = "and LABORATORY = 'NILU'"
  )

# table(df_temporary$UNIT)

nrow(df_temporary)

df_temporary2 <- df_temporary %>%
  filter(UNIT %in% c("µg/l", "µg/L", "ng/l", "ng/L"))

nrow(df_temporary2)

```
#### Modify 'NAME_modified'  

```{r}

dat_water_a_rest_2 <- dat_water_a_rest %>%
  mutate(
    NAME_modified = case_when(
      grepl("^BDE[0-9]", NAME_modified) ~ sub("BDE", "BDE-", NAME_modified),
      grepl("^CB[0-9]", NAME_modified) ~ sub("CB", "PCB-", NAME_modified),
      TRUE ~ NAME_modified)
  )

```

#### Get Methods 
```{r}

# table(dat_water_a_rest_2$NAME_modified)

df_temporary <- get_nivabase_selection(
  "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
  "METHOD_DEFINITIONS", 
  "NAME", 
  unique(dat_water_a_rest_2$NAME_modified), values_are_text = TRUE, 
  extra_sql = "and LABORATORY = 'NILU'"
  )

# table(df_temporary$UNIT)

nrow(df_temporary)

df_names_water_extra <- df_temporary %>%
  filter(UNIT %in% c("µg/l", "µg/L", "ng/l", "ng/L"),
         !is.na(METHOD_REF))

nrow(df_names_water_extra)  


```

#### Check for duplicates  

```{r}

df_check <- df_names_water_extra %>%
  add_count(NAME) %>%
  filter(n > 1)

if (nrow(df_check) > 0)
  stop("Duplicates!")

```


#### Data set   

```{r}

dat_temporary <- dat_water_a_rest_2 %>%
  select(-c(METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID)) %>%
  left_join(df_names_water_extra, by = c("NAME_modified" = "NAME"))

if (nrow(dat_water_a_rest_2) != nrow(dat_temporary))
  stop("Number of rows increased!")

dat_water_b <- dat_temporary %>%
  filter(!is.na(METHOD_ID))

dat_water_b_rest <- dat_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(dat_water_b), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(dat_water_b_rest), "rows")

df_names_lacking_b <- dat_water_b_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_b), "names \n\n")

cat("Sum:", nrow(dat_water_b) + nrow(dat_water_b_rest), "rows \n\n")

cat("UNIT for rows with METHOD_ID: \n")
table(addNA(dat_water_b$UNIT))

```

### Combine set a and b  

```{r}

dat_water_comb <- bind_rows(
  dat_water_a, 
  dat_water_b
)

```

#### Check matrix  

- Some lack MATRIX and MATRIX_ID

```{r}

dat_water_comb %>%
  count(MATRIX, MATRIX_ID)

```

### Add methods    

#### Check units  

```{r}

df_methods_to_add_wat <- dat_water_comb %>%
  filter(is.na(MATRIX)) %>% # nrow()
  distinct(NAME_modified, UNIT, LABORATORY, METHOD_REF) %>%
  rename(NAME = NAME_modified) %>%
  mutate(
    MATRIX = "WATER", 
    MATRIX_ID = 3,
    CAS = as.character(NA)
  )

```



#### Make SQLs    

PASTE INTO SQL DEVELOPER TO ADD THE RECORDS    

- Need NAME, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID  
Note to DHJ: use "SQL developer (latest version)" from desktop. Don't use the start menu.  
- remember `commit;` after running the insert sentences  

```{r}

sql_list <- 1:nrow(df_methods_to_add_wat) %>% 
  map_chr(make_sql_methods, data = df_methods_to_add_wat)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")  
writeLines(sql, "clipboard")  # copies SQLs to clipboard - go to SQL Developer and paste

cat("Number of SQLs: \n")
length(sql_list)  # 9


cat("\nSample of SQLs: \n")
sql_list[1:3]

```



#### Get the records we just added   

- Also checks that the number of new records is the same as no. of SQLs  
- Remember to **commit** in SQL developer first  

```{r}

if (FALSE){

  library(niRvana)
  
  # day_for_adding_records <- substr(lubridate::now(tzone = "UTC"), 1, 10)
  day_for_adding_records <- "2023-02-21"
  
  water_methods_added_to_database <- niRvana::get_nivabase_data(paste(
    "select NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID",
    "from NIVADATABASE.METHOD_DEFINITIONS",
    "where TRUNC(ENTERED_DATE) = TO_DATE(", sQuote(day_for_adding_records), ", 'yyyy-mm-dd')", 
    " and ENTERED_BY = 'DHJ'")
  )
  
  cat("Number of retrieved records: ")
  n_records2 <- nrow(water_methods_added_to_database)
  n_records2
  
  write.table(water_methods_added_to_database, "Data/0110_water_methods_added_to_database2.txt", 
              sep = "\t", row.names = FALSE)
  
  
}

water_methods_added_to_database <- read.table(
  "Data/0110_water_methods_added_to_database2.txt", header = TRUE)

```

### Replace methods without MATRIX  

```{r}

dat_temporary1 <- dat_water_comb %>%
 filter(
   !NAME_modified %in% water_methods_added_to_database$NAME
 )

dat_temporary2 <- dat_water_comb %>%
  filter(
    NAME_modified %in% water_methods_added_to_database$NAME
  ) %>%
  select(-c(METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID)) %>%
  left_join(water_methods_added_to_database, by = c("NAME_modified" = "NAME"))

nrow(dat_temporary1)
nrow(dat_temporary2)

if (nrow(dat_temporary1) + nrow(dat_temporary2) != nrow(dat_water_comb))
  stop("The sum of rows should equal the original file")


dat_water_comb2 <- bind_rows(
  dat_temporary1,
  dat_temporary2
)

```


#### Check matrix  

- Some lack MATRIX and MATRIX_ID

```{r}

dat_water_comb2 %>%
  count(MATRIX, MATRIX_ID)

```



### Add Water fraction measurements to Nivabasen  


#### Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS  
```{r}

# Needs 
# WATER_SAMPLE_ID, METHOD_ID, VALUE, FLAG1, APPROVED

sql_list <- 1:nrow(dat_water_comb2) %>% 
  map_chr(make_sql_waterchemistry_values, 
          data = dat_water_comb2)
length(sql_list) # 7957

i <- 1:length(sql_list)
sql <- paste(sql_list[i], collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard-4096")   # copies SQLs to clipboard - go to SQL Developer and paste
                                    # "clipboard-1024" instead of "clipboard": increases avaliable
                                      #    for the clipboard
cat("Length of sql_list:", 
    length(sql_list), "\n\n")

cat("Two first and two last SQLs: \n\n")
head(sql_list, 2)
cat("-------------------------------------\n")
tail(sql_list, 2)

#
# See 'Urbanfjord_biota_measurements_5sql' in SQL Developer
# C:\Users\DHJ\AppData\Roaming\SQL Developer
#

```

### Particle fraction - add methods      

#### Check names   ¨

- must not end with '-P'!  

```{r}

df_check <- dat_water_comb2 %>%
  mutate(
    last_letter = stringr::str_sub(NAME_modified, -1)
  ) %>%
  distinct(NAME_modified, last_letter) %>%
  filter(last_letter %in% c("p", "P"))

# df_check

df_check2 <- df_check %>%
  mutate(second_last_letter = stringr::str_sub(NAME_modified, -2, -2)) %>%
  filter(second_last_letter == "-")

if (nrow(df_check2) > 0){
  stop("Some parameters end with -P!")
}

```


#### Create methods for particles   

- Just add '-P' to existing NAME for water 

```{r}

df_methods_to_add_watpart <- dat_water_comb2 %>%
  distinct(
    NAME_modified, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID
  ) %>%
  mutate(
    NAME = paste0(NAME_modified, "-P")
  )

```


#### Make SQLs    

PASTE INTO SQL DEVELOPER TO ADD THE RECORDS    

- Need NAME, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID  
Note to DHJ: use "SQL developer (latest version)" from desktop. Don't use the start menu.  
- remember `commit;` after running the insert sentences  

```{r}

sql_list <- 1:nrow(df_methods_to_add_watpart) %>% 
  map_chr(make_sql_methods, data = df_methods_to_add_watpart)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")  
writeLines(sql, "clipboard-4096")  # copies SQLs to clipboard - go to SQL Developer and paste

cat("Number of SQLs: \n")
length(sql_list)  # 9


cat("\nSample of SQLs: \n")
sql_list[1:3]

```



#### Get the records we just added   

- Also checks that the number of new records is the same as no. of SQLs  
- Remember to **commit** in SQL developer first  

```{r}

if (FALSE){

  library(niRvana)
  
  # day_for_adding_records <- substr(lubridate::now(tzone = "UTC"), 1, 10)
  day_for_adding_records <- "2023-02-21"
  
  dat_temporary <- niRvana::get_nivabase_data(paste(
    "select NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID",
    "from NIVADATABASE.METHOD_DEFINITIONS",
    "where TRUNC(ENTERED_DATE) = TO_DATE(", sQuote(day_for_adding_records), ", 'yyyy-mm-dd')", 
    " and ENTERED_BY = 'DHJ'")
  )
  
  cat("Number of retrieved records: ")
  n_records2 <- nrow(dat_temporary)
  n_records2
  
  nrow(dat_temporary)
  waterpart_methods_added_to_database <- dat_temporary %>%
    filter(METHOD_ID > 38797)
  nrow(waterpart_methods_added_to_database)
  
  write.table(waterpart_methods_added_to_database,
              "Data/0110_waterpart_methods_added_to_database.txt", 
              sep = "\t", row.names = FALSE)
  
  
}

waterpart_methods_added_to_database <- read.table(
  "Data/0110_waterpart_methods_added_to_database.txt", header = TRUE)

```


### Particle fraction - add measurements  

#### Add to particle fraction data 'dat_water_p_1'    

```{r}

# Add NAME_modified  
dat_water_p_2 <- dat_water_p_1 %>%
  left_join(lookup_names_biota %>% select(NAME_orig, NAME_modified))

# Fix NAME_modified for metals
# dat_water_p_2 %>% filter(is.na(NAME_modified)) %>% count(NAME_orig) %>% pull(NAME_orig) %>% dput()

metals_sentencecase <- c("Ag", "As", "Cd", "Cr", "Cu", "Fe", "Ni", "Pb", "Sb", "Zn", "Hg") 
metals_uppercase <- toupper(metals_sentencecase)
dat_water_p_2 <- dat_water_p_2 %>%
  # From set 'a' above  
  mutate(
    NAME_modified = case_when(
      NAME_orig %in% metals_sentencecase ~ NAME_orig,
      NAME_modified %in% metals_uppercase ~ stringr::str_to_sentence(NAME_modified),
      TRUE ~ NAME_modified)
  ) %>%
  # From set 'b' above  
  mutate(
    NAME_modified = case_when(
      grepl("^BDE[0-9]", NAME_modified) ~ sub("BDE", "BDE-", NAME_modified),
      grepl("^CB[0-9]", NAME_modified) ~ sub("CB", "PCB-", NAME_modified),
      TRUE ~ NAME_modified)
  ) %>%
  # Then add -P    
  mutate(
    NAME_modified = paste0(NAME_modified, "-P")
  )
  
dat_water_p_3 <- dat_water_p_2 %>%
  left_join(waterpart_methods_added_to_database, by = c("NAME_modified" = "NAME"))  

```

#### Check  

```{r}

if (sum(is.na(dat_water_p_3$METHOD_ID)) > 0)
  stop("Lacking METHOD_ID for some!")

```


#### Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS  
```{r}

# Needs 
# WATER_SAMPLE_ID, METHOD_ID, VALUE, FLAG1, APPROVED

sql_list <- 1:nrow(dat_water_p_3) %>% 
  map_chr(make_sql_waterchemistry_values, 
          data = dat_water_p_3)
length(sql_list) # 7957

i <- 1:length(sql_list)
sql <- paste(sql_list[i], collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard-4096")   # copies SQLs to clipboard - go to SQL Developer and paste
                                    # "clipboard-1024" instead of "clipboard": increases avaliable
                                      #    for the clipboard
cat("Length of sql_list:", 
    length(sql_list), "\n\n")

cat("Two first and two last SQLs: \n\n")
head(sql_list, 2)
cat("-------------------------------------\n")
tail(sql_list, 2)

#
# See 'Urbanfjord_biota_measurements_5sql' in SQL Developer
# C:\Users\DHJ\AppData\Roaming\SQL Developer
#

```


## 16. SEDIMENT 2020-21   

### Create data 'df_nilu_03_bio_01'   
```{r}

df_temporary <- df_nilu_03 %>% 
  filter(!is.na(LABWARE_SLICEID_ID))

cat("Sediment data:", nrow(df_temporary), "rows \n")

df_temporary <- df_temporary %>% 
    filter(
    !(grepl("^Sum", NAME_orig) & grepl("CB", NAME_orig))
  )
cat("- exclude PCB sums:", nrow(df_temporary), "rows \n")

df_temporary_02 <- df_temporary %>%
  filter(
    NAME_orig != "4-[2-(4-{[benzyl(triphenyl)-lambda~5~-phosphanyl]oxy}phenyl)-1,1,1,3,3,3-hexafluoropropan-2-yl]phenol"
  )

cat("- exclude '4-[2-(4-{[benzyl(triphenyl)-lambda~5~-phosphanyl]oxy}phenyl)-1,1,1,3,3,3-hexafluoropropan-2-yl]phenol' (too long name) \n")
cat("Final data: ", nrow(df_nilu_03_sed_01), "rows \n")

```

### Correct LABWARE_SLICEID_ID  

* Correct IDs from Benno  

```{r}

# CORRECT NUMBERS:
# 2020-06-26 00:00:00.000    291373
# 2020-06-27 00:00:00.000    291374
# 2020-08-01 00:00:00.000    291585
# 2021-08-05 00:00:00.000    291584

xtabs(~LIMS.NR, df_nilu_2020_all %>% filter(Matrix %in% "Renseanl. Slam"))
xtabs(~LIMS.NR, df_nilu_2020_all %>% filter(Matrix %in% "Sediment"))
xtabs(~LIMS, df_nilu_2021 %>% filter(`Sample type[LIMS]` %in% "Sediment"))


df_nilu_03_sed_01 <- df_temporary_02 %>% 
  mutate(
    LABWARE_SLICEID_ID = case_when(
      LIMS.NR == "NR-2020-08173" ~ 291373,
      LIMS.NR == "NR-2020-08174" ~ 291374,
      LIMS.NR == "NR-2020-08522" ~ 291585,
      LIMS.NR == "NR-2021-07948" ~ 291584)
  )

# Check
table(addNA(df_nilu_03_sed_01$LABWARE_SLICEID_ID))

```


### Check samples and years  
```{r}

cat("LIMS.NR: \n")
with(df_nilu_03_sed_01, table(LIMS.NR, substr(LIMS.NR, 4, 7)))

cat("LIMS.NR: \n")
with(df_nilu_03_sed_01, table(LIMS.NR, addNA(LABWARE_SLICEID_ID)))

```


### Check 'Unit' from data  
```{r}

table(addNA(df_nilu_03_sed_01$Unit))

#
# Metals have ug/g and ug/L
#
table(subset(df_nilu_03_sed_01, Unit == "ug/g")$NAME_orig)
table(subset(df_nilu_03_sed_01, Unit == "ug/L")$NAME_orig)

```

### Set 'a': Add methods from methods file  


- Starting with the manual file for *biota* data (w.w. data)   
- Use 'Substance' from this file to look for corresponding *sediment* methods      
- Added to data using 'NAME_modified' in the data, creating data set 'a'  


#### Get methods and join to data 
```{r}


lookup_methods_bio_excel <- readxl::read_excel(
  "Input_data/Lookup_files/lookup_params_2020-21.xlsx")  

# stop("Then see if we can find the same NAME for sediments (check matrix) ")

if (FALSE){
  
  library(niRvana)
  
  # Just for checking, not used later  
  lookup_methods_check <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID",
    "METHOD_DEFINITIONS", 
    "LABORATORY", values_are_text = TRUE,
    "NILU")
  
  lookup_methods_check_dw <- lookup_methods_check %>%
    filter(MATRIX %in% "Sediment" | grepl("d.w.", UNIT)) %>%
    filter(!grepl("pg", UNIT))   # drop pg/g
    
    
  # Get methods by name  
  lookup_methods_sed_1a <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID",
    "METHOD_DEFINITIONS", 
    "NAME", values_are_text = TRUE,
    unique(lookup_methods_bio_excel$Substance),
    extra_sql = "and LABORATORY = 'NILU'")
  
  # Add metales by name (sentence-case)    
  lookup_methods_sed_1b <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID",
    "METHOD_DEFINITIONS", 
    "NAME", values_are_text = TRUE,
    c("Ag", "Cd", "Sb", "Pb", "Cr", "Fe", "Ni", "Cu", "Zn", "As"),
    extra_sql = "and LABORATORY = 'NILU'")

  # Check unit + matrix
  # Sediment methods can have either MATRIX = Sediment or 'd.w.' in UNIT: 
  with(lookup_methods_sed_1a,
       table(addNA(UNIT), addNA(MATRIX))
  )
  
  # Pick those given as above (in addition, drop pg/g, we don't have that)
  lookup_methods_sed_1c <- bind_rows(
    lookup_methods_sed_1a,
    lookup_methods_sed_1b) %>%
    filter(MATRIX %in% "Sediment" | grepl("d.w.", UNIT)) %>%
    filter(!grepl("pg", UNIT))   # drop pg/g
  
  # New check
  with(lookup_methods_sed_1c,
       table(addNA(UNIT), addNA(MATRIX))
  )
  
  # Split in those with dublettes and thos without
  lookup_nondub <- lookup_methods_sed_1c %>%
    add_count(NAME) %>% 
    filter(n == 1)
  lookup_dub <- lookup_methods_sed_1c %>%
    add_count(NAME) %>% 
    filter(n > 1)
  
  # For dublettes, pick those with analytical method given,
  #   otherwise we pick thos with highest METHOD_ID (added latest)  
  lookup_dub2 <- lookup_dub %>%
    arrange(NAME, is.na(METHOD_REF), desc(METHOD_ID)) %>%
    group_by(NAME) %>%
    mutate(Count = 1:length(NAME)) %>%
    filter(Count == 1) %>%
    select(-Count)

  check <- !lookup_dub$NAME %in% lookup_dub2$NAME
  if (sum(check) > 0)
    stop("Some are lacking after the last filtering")

  lookup_methods_sed_1 <- bind_rows(
    lookup_nondub, 
    lookup_dub2 
  )

  # saveRDS(lookup_methods_sed_1, "Data/0110_lookup_methods_sed_1.rds")
  
}

lookup_methods_sed_1 <- readRDS("Data/0110_lookup_methods_sed_1.rds")

df_temporary <- df_nilu_03_sed_01 %>%
  ungroup() %>%
  mutate(
    # Make NAME_modified as for biota, EXCEPT don't put metals in upper case 
    NAME_modified = case_when(
      grepl("^[0-9][0-9]\\s", NAME_orig) ~ substr(NAME_orig,5,6),
      grepl("^[0-9][0-9][0-9]\\s", NAME_orig) ~ substr(NAME_orig,6,7),
      grepl("^PBDE", NAME_orig) ~ sub("PBDE", "BDE", NAME_orig),
      grepl("^BDE[0-9]", NAME_orig) ~ sub("BDE", "BDE-", NAME_orig),
      grepl("^CB[0-9]", NAME_orig) ~ sub("CB", "PCB-", NAME_orig),
      TRUE ~ NAME_orig),
  ) %>%
  left_join(lookup_methods_sed_1, by = c("NAME_modified" = "NAME"))

```


#### Check units  
```{r}

df_temporary %>% 
  count(Unit, UNIT)

```

#### Fix units  
```{r}

df_temporary_fix <- df_temporary %>%
  mutate(
    VALUE = case_when(
       Unit == "ng/g" & UNIT == "µg/g d.w." ~ VALUE/1000,
       TRUE ~ VALUE),
    Unit = case_when(
       Unit == "ng/g" & UNIT == "µg/g d.w." ~ "ug/g",
       TRUE ~ Unit)
  )


```


#### Check units again  
```{r}

df_temporary_fix %>% 
  count(Unit, UNIT)

```

#### Make data set 'a'  
```{r}

df_nilu_03_sed_a <- df_temporary_fix %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_sed_a_rest <- df_temporary_fix %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_sed_a), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_sed_a_rest), "rows")

df_names_lacking_a <- df_nilu_03_sed_a_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_a), "names \n\n")

cat("Sum:", nrow(df_nilu_03_sed_a) + nrow(df_nilu_03_sed_a_rest), "rows \n\n")

cat("UNIT for rows with METHOD_ID: \n")
table(addNA(df_nilu_03_sed_a$UNIT))


```


### Set 'b': Add methods from search on NAME_modified    

- Based on the 'rest' from set a  

```{r}

if (FALSE){
  
  # Search for suitable methods using 'NAME_modified'  
  # - must be ww unit with NILU as lab  
  lookup_method_id_dw_1a <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
    "METHOD_DEFINITIONS", 
    "NAME", 
    df_names_lacking_a$NAME_modified, values_are_text = TRUE, 
    extra_sql = "and UNIT like '%d.w%' and LABORATORY = 'NILU'"
  )
  
  # Remove dublettes (pick thos with METHOD_REF, otherwise highest METHOD_ID)
  lookup_method_id_dw_1 <- lookup_method_id_dw_1a %>%
    arrange(NAME, is.na(METHOD_REF), desc(METHOD_ID)) %>%
    group_by(NAME) %>%
    mutate(Count = 1:length(NAME)) %>%
    filter(Count == 1) %>%
    select(-Count)
  
  saveRDS(lookup_method_id_dw_1, "Data/0110_lookup_method_id_dw_1.rds")
}

lookup_method_id_dw_1 <- readRDS("Data/0110_lookup_method_id_dw_1.rds")

check <- lookup_method_id_dw_1 %>%
  add_count(NAME) %>% 
  filter(n > 1)
if (nrow(check) > 0)
  stop("Dublettes in the names")
  

lookup_method_id_dw <- lookup_method_id_dw_1

# data
df_temporary <- df_nilu_03_sed_a_rest %>%
  select(-c(METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID)) %>%
  left_join(lookup_method_id_dw, by = c("NAME_modified" = "NAME"))

df_nilu_03_sed_b <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_sed_b_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_sed_b), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_sed_b_rest), "rows")

df_names_lacking_b <- df_nilu_03_sed_b_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_b), "names \n\n")
cat("Sum:", nrow(df_nilu_03_sed_b) + nrow(df_nilu_03_sed_b_rest), "rows")


if (F){
  writexl::write_xlsx(
    list(df_names_lacking_b, lookup_method_id_dw),
    "Data/0110_df_dryweight_names_lacking_b.xlsx")
}

```
#### Check units  
```{r}

df_nilu_03_sed_b %>% 
  count(Unit, UNIT)

```


### Set 'c': Add final existing methods   

* Use '0110_dat_nivabase_nilu_methods.xlsx' to modify '0110_df_dryweight_names_lacking_b.xlsx'
    - adding columns NAME, METHOD_ID, UNIT, MATRIX, LABORATORY for existing methods where we have a match  
* Resulting excel: '0110_df_names_edited_dryweight.xlsx'
* Using a look-up table for the names  

```{r}

df_names_edited <- readxl::read_excel("Data/0110_df_names_edited_dryweight.xlsx")

# data
df_temporary <- df_nilu_03_sed_b_rest %>%
  select(-c(METHOD_ID, UNIT, MATRIX, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID)) %>%
  left_join(df_names_edited %>% select(-NAME_orig), by = c("NAME_modified"))

df_nilu_03_sed_c <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_sed_c_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_sed_c), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_sed_c_rest), "rows")

df_names_lacking_c <- df_nilu_03_sed_c_rest %>%
  distinct(NAME_modified, Unit)

cat(" and", nrow(df_names_lacking_c), "names \n\n")
cat("Sum:", nrow(df_nilu_03_sed_c) + nrow(df_nilu_03_sed_c_rest), "rows")


```
#### Check units  
```{r}

df_nilu_03_sed_c %>% 
  count(Unit, UNIT)

```

### Add methods    


#### Make data for adding to METHOD_DEFINITIONS   
```{r}

cat("Check units of parameters that will be added: \n")
tab <- table(df_names_lacking_c$Unit)
tab
if (sum(is.na(df_names_lacking_c$Unit)) > 0)
  stop("There are data without units!")
unit_is_ng_p_g <- grepl("ng/g", df_names_lacking_c$Unit)
if (mean(unit_is_ng_p_g) < 1)
  stop("There are data that don't have ng/g unit")

df_methods_to_add_sed <- df_names_lacking_c %>%
  filter(!is.na(Unit)) %>%
  distinct(NAME_modified) %>%
  rename(NAME = NAME_modified) %>%
  as.data.frame()

df_methods_to_add_sed$UNIT <- "ng/g d.w."     # NOTE: rememebr 'd.w.' here
df_methods_to_add_sed$LABORATORY <- "NILU"
df_methods_to_add_sed$MATRIX <- "Sediment"
df_methods_to_add_sed$MATRIX_ID <- 2
df_methods_to_add_sed$CAS <- NA
df_methods_to_add_sed$METHOD_REF <- NA

# saveRDS(df_methods_to_add_sed, "Data/0110_df_methods_to_add_sed.rds")

```

#### Make SQLs    

PASTE INTO SQL DEVELOPER TO ADD THE RECORDS    

- Need NAME, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID  
Note to DHJ: use "SQL developer (latest version)" from desktop. Don't use the start menu.  
- remember `commit;` after running the insert sentences  

```{r}

sql_list <- 1:nrow(df_methods_to_add_sed) %>% 
  map_chr(make_sql_methods, data = df_methods_to_add_sed)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")  
writeLines(sql, "clipboard")  # copies SQLs to clipboard - go to SQL Developer and paste

cat("Number of SQLs: \n")
length(sql_list)  # 9


cat("\nSample of SQLs: \n")
sql_list[1:3]

```

### Get the records we just added   

- Also checks that the number of new records is the same as no. of SQLs  
- Remember to **commit** in SQL developer first  

```{r}

if (FALSE){

  library(niRvana)
  
  # day_for_adding_records <- substr(lubridate::now(tzone = "UTC"), 1, 10)
  day_for_adding_records <- "2023-02-14"
  
  sed_methods_added_to_database <- niRvana::get_nivabase_data(paste(
    "select NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID",
    "from NIVADATABASE.METHOD_DEFINITIONS",
    "where TRUNC(ENTERED_DATE) = TO_DATE(", sQuote(day_for_adding_records), ", 'yyyy-mm-dd')", 
    " and ENTERED_BY = 'DHJ'")
  )
  
  cat("Number of retrieved records: ")
  n_records2 <- nrow(sed_methods_added_to_database)
  n_records2
  
  write.table(sed_methods_added_to_database, "Data/0110_sed_methods_added_to_database.txt", 
              sep = "\t", row.names = FALSE)
  
}

sed_methods_added_to_database_1 <- read.table("Data/0110_sed_methods_added_to_database.txt", header = TRUE)


```

#### Add some extra, if needed  

```{r}

# If needed, somthing like this:
#
# lookup_extra1 <- structure(
#   list(
#     NAME = c("4-Nonylphenol", "4-tert-Octylphenol"), 
#     METHOD_ID = c(32390, 32454), UNIT = c("ng/g w.w.", "ng/g w.w."), LABORATORY = c("NILU", "NILU"), 
#     METHOD_REF = c("LC-QToF", "LC-QToF"), MATRIX = c("BIOTA", "BIOTA"), MATRIX_ID = c(1, 1)), 
#   class = "data.frame", row.names = c(NA, -2L)
# )

# sed_methods_added_to_database <- bind_rows(sed_methods_added_to_database_1, lookup_extra1)

sed_methods_added_to_database <- sed_methods_added_to_database_1

```


### Set 'd': Added methods are added to data  

- Based on the 'rest' from set b  
- Using NAME_modified   

```{r}

# data
df_temporary <- df_nilu_03_sed_c_rest %>%
  select(-c(METHOD_ID, UNIT, LABORATORY, MATRIX)) %>%
  left_join(sed_methods_added_to_database, by = c("NAME_modified" = "NAME"))

df_nilu_03_sed_d <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_sed_d_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_sed_d), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_sed_d_rest), "rows")

df_names_lacking_d <- df_nilu_03_sed_d_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_d), "names \n\n")
cat("Sum:", nrow(df_nilu_03_sed_d) + nrow(df_nilu_03_sed_d_rest), "rows")


if (F){
  writexl::write_xlsx(
    list(df_names_lacking_b, lookup_method_id_dw),
    "Data/0110_df_names_lacking_b.xlsx")
}

```

### Combine a, b, c and d   

```{r}

df_nilu_03_sed_02 <- bind_rows(
  df_nilu_03_sed_a,
  df_nilu_03_sed_b,
  df_nilu_03_sed_c,
  df_nilu_03_sed_d
) %>%
  select(-SAMPLE_ID) %>%
  rename(SLICE_ID = LABWARE_SLICEID_ID) %>%
  # Set MATRIX - see check of existing data in the next chunk
  mutate(MATRIX = "NS")

if (nrow(df_nilu_03_sed_01) != nrow(df_nilu_03_sed_02)){
  stop("Number of rows should be the same")
}

if (sum(is.na(df_nilu_03_sed_02$SLICE_ID)) > 0){
  stop("Some SLICE_ID are lacking!")
}

# check <- df_nilu_03_sed_02 %>%
#   filter(is.na(SLICE_ID))

```

### Check units  
```{r}

df_nilu_03_sed_02 %>%
  count(Unit, UNIT)

```


### Check existing sediment data (NIVA data)    
```{r}

df_check <- get_nivabase_selection(
  "*",
  "SEDIMENT_CHEMISTRY_VALUES",
  "SLICE_ID",
  unique(df_nilu_03_sed_02$SLICE_ID))

df_check_meth <- get_nivabase_selection(
  "METHOD_ID, NAME, UNIT, MATRIX",
  "METHOD_DEFINITIONS",
  "METHOD_ID",
  df_check$METHOD_ID
)

df_check <- df_check %>%
  left_join(df_check_meth, by = "METHOD_ID")

xtabs(~SLICE_ID, df_check)
  
# MATRIX = NS
# FRACTION_SIZE = NULL

```


### Add measurements to Nivabasen  

### Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS  
```{r}

# df_nilu_03_sed_02

# make_sql_sedimentchemistry_values 
#   expects olumn names
# SLICE_ID, METHOD_ID, MATRIX, VALUE, FLAG1

# Test
# make_sql_sedimentchemistry_values(1, df_nilu_03_sed_02)

sql_list <- 1:nrow(df_nilu_03_sed_02) %>% 
  map_chr(make_sql_sedimentchemistry_values, 
          data = df_nilu_03_sed_02)
length(sql_list) # 399

i <- 1:length(sql_list)
sql <- paste(sql_list[i], collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard-4096")   # copies SQLs to clipboard - go to SQL Developer and paste
                                    # "clipboard-1024" instead of "clipboard": increases avaliable
                                      #    for the clipboard
cat("Length of sql_list:", 
    length(sql_list), "\n\n")

cat("Two first and two last SQLs: \n\n")
head(sql_list, 2)
cat("-------------------------------------\n")
tail(sql_list, 2)

#
# See 'Urbanfjord_biota_measurements_5sql' in SQL Developer
# C:\Users\DHJ\AppData\Roaming\SQL Developer
#

```


## 16. SEDIMENT 2019     

### Check existing sediment data (NIVA data)    
```{r}

df_check <- get_nivabase_selection(
  "*",
  "SEDIMENT_CHEMISTRY_VALUES",
  "SLICE_ID",
  286780)       # HARD-CODED From appendix 4 part 5

df_check_meth <- get_nivabase_selection(
  "METHOD_ID, NAME, UNIT, MATRIX",
  "METHOD_DEFINITIONS",
  "METHOD_ID",
  df_check$METHOD_ID
)

df_check <- df_check %>%
  left_join(df_check_meth, by = "METHOD_ID")

xtabs(~NAME + SLICE_ID, df_check)
  
# MATRIX = NS
# FRACTION_SIZE = NULL

```


```{r}

# dat_2019 <- read_excel("Input_data/2013-2019/ElectronicAppendix2019.xlsx")
dat_2019_all <- readRDS("Input_data/2013-2019/992_df_excel_2019.rds")

table(addNA(dat_2019_all$Compartment))

dat_2019 <- dat_2019_all %>%
  filter(Compartment %in% "Sediment") %>%
  mutate(LABWARE_SLICEID_ID = 286780)       # HARD-CODED From appendix 4 part 5:

```

### Create data 'df_nilu_03_bio_01'   
```{r}

table(addNA(dat_2019$Lab))

df_nilu_03_sed_01 <- dat_2019 %>%
  rename(LIMS.NR = TEXT_ID,
         NAME_orig = Substance) %>%
  filter(Lab %in% "NILU")

```




### Check samples and years  
```{r}

cat("LIMS.NR: \n")
with(df_nilu_03_sed_01, table(LIMS.NR, substr(LIMS.NR, 4, 7)))

cat("LIMS.NR: \n")
with(df_nilu_03_sed_01, table(LIMS.NR, addNA(LABWARE_SLICEID_ID)))

```


### Check 'Unit' from data  
```{r}

table(addNA(df_nilu_03_sed_01$Unit))

```


### Check 'Unit' from data  
```{r}

table(addNA(df_nilu_03_sed_01$NAME_orig))


```

### Set 'a': Add methods from methods file  


- Starting with the manual file for *biota* data (w.w. data)   
- Use 'Substance' from this file to look for corresponding *sediment* methods      
- Added to data using 'NAME_modified' in the data, creating data set 'a'  


#### Get methods and join to data 
```{r}


lookup_methods_bio_excel <- readxl::read_excel(
  "Input_data/Lookup_files/lookup_params_2020-21.xlsx")  

# stop("Then see if we can find the same NAME for sediments (check matrix) ")

if (FALSE){
  
  library(niRvana)
  
  # Just for checking, not used later  
  lookup_methods_check <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID",
    "METHOD_DEFINITIONS", 
    "LABORATORY", values_are_text = TRUE,
    "NILU")
  
  lookup_methods_check_dw <- lookup_methods_check %>%
    filter(MATRIX %in% "Sediment" | grepl("d.w.", UNIT)) %>%
    filter(!grepl("pg", UNIT))   # drop pg/g
    
    
  # Get methods by name  
  lookup_methods_sed_1a <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID",
    "METHOD_DEFINITIONS", 
    "NAME", values_are_text = TRUE,
    unique(lookup_methods_bio_excel$Substance),
    extra_sql = "and LABORATORY = 'NILU'")
  
  # Add metales by name (sentence-case)    
  lookup_methods_sed_1b <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID",
    "METHOD_DEFINITIONS", 
    "NAME", values_are_text = TRUE,
    c("Ag", "Cd", "Sb", "Pb", "Cr", "Fe", "Ni", "Cu", "Zn", "As"),
    extra_sql = "and LABORATORY = 'NILU'")

  # Check unit + matrix
  # Sediment methods can have either MATRIX = Sediment or 'd.w.' in UNIT: 
  with(lookup_methods_sed_1a,
       table(addNA(UNIT), addNA(MATRIX))
  )
  
  # Pick those given as above (in addition, drop pg/g, we don't have that)
  lookup_methods_sed_1c <- bind_rows(
    lookup_methods_sed_1a,
    lookup_methods_sed_1b) %>%
    filter(MATRIX %in% "Sediment" | grepl("d.w.", UNIT)) %>%
    filter(!grepl("pg", UNIT))   # drop pg/g
  
  # New check
  with(lookup_methods_sed_1c,
       table(addNA(UNIT), addNA(MATRIX))
  )
  
  # Split in those with dublettes and thos without
  lookup_nondub <- lookup_methods_sed_1c %>%
    add_count(NAME) %>% 
    filter(n == 1)
  lookup_dub <- lookup_methods_sed_1c %>%
    add_count(NAME) %>% 
    filter(n > 1)
  
  # For dublettes, pick those with analytical method given,
  #   otherwise we pick thos with highest METHOD_ID (added latest)  
  lookup_dub2 <- lookup_dub %>%
    arrange(NAME, is.na(METHOD_REF), desc(METHOD_ID)) %>%
    group_by(NAME) %>%
    mutate(Count = 1:length(NAME)) %>%
    filter(Count == 1) %>%
    select(-Count)

  check <- !lookup_dub$NAME %in% lookup_dub2$NAME
  if (sum(check) > 0)
    stop("Some are lacking after the last filtering")

  lookup_methods_sed_1 <- bind_rows(
    lookup_nondub, 
    lookup_dub2 
  )

  # saveRDS(lookup_methods_sed_1, "Data/0110_lookup_methods_sed_1.rds")
  
}

lookup_methods_sed_1 <- readRDS("Data/0110_lookup_methods_sed_1.rds")

df_temporary <- df_nilu_03_sed_01 %>%
  ungroup() %>%
  mutate(
    # Make NAME_modified as for biota, EXCEPT don't put metals in upper case 
    NAME_modified = case_when(
      grepl("^[0-9][0-9]\\s", NAME_orig) ~ substr(NAME_orig,5,6),
      grepl("^[0-9][0-9][0-9]\\s", NAME_orig) ~ substr(NAME_orig,6,7),
      grepl("^PBDE", NAME_orig) ~ sub("PBDE", "BDE", NAME_orig),
      grepl("^BDE[0-9]", NAME_orig) ~ sub("BDE", "BDE-", NAME_orig),
      grepl("^CB[0-9]", NAME_orig) ~ sub("CB", "PCB-", NAME_orig),
      TRUE ~ NAME_orig),
  ) %>%
  left_join(lookup_methods_sed_1, by = c("NAME_modified" = "NAME"))

```


#### Check units  
```{r}

df_temporary %>% 
  count(Unit, UNIT)

```

#### Fix units  
```{r}

# NOT NEEDED HERE

# df_temporary_fix <- df_temporary %>%
#   mutate(
#     VALUE = case_when(
#        Unit == "ng/g" & UNIT == "µg/g d.w." ~ VALUE/1000,
#        TRUE ~ VALUE),
#     Unit = case_when(
#        Unit == "ng/g" & UNIT == "µg/g d.w." ~ "ug/g",
#        TRUE ~ Unit)
#   )

df_temporary_fix <- df_temporary


```


#### Check units again  
```{r}

df_temporary_fix %>% 
  count(Unit, UNIT)

```

#### Make data set 'a'  
```{r}

df_nilu_03_sed_a <- df_temporary_fix %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_sed_a_rest <- df_temporary_fix %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_sed_a), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_sed_a_rest), "rows")

df_names_lacking_a <- df_nilu_03_sed_a_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_a), "names \n\n")

cat("Sum:", nrow(df_nilu_03_sed_a) + nrow(df_nilu_03_sed_a_rest), "rows \n\n")

cat("UNIT for rows with METHOD_ID: \n")
table(addNA(df_nilu_03_sed_a$UNIT))


```


### Set 'b': Add methods from search on NAME_modified    

- Based on the 'rest' from set a  

```{r}

if (FALSE){
  
  # Search for suitable methods using 'NAME_modified'  
  # - must be ww unit with NILU as lab  
  lookup_method_id_dw_1a <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
    "METHOD_DEFINITIONS", 
    "NAME", 
    df_names_lacking_a$NAME_modified, values_are_text = TRUE, 
    extra_sql = "and UNIT like '%d.w%' and LABORATORY = 'NILU'"
  )
  
  # Remove dublettes (pick thos with METHOD_REF, otherwise highest METHOD_ID)
  lookup_method_id_dw_1 <- lookup_method_id_dw_1a %>%
    arrange(NAME, is.na(METHOD_REF), desc(METHOD_ID)) %>%
    group_by(NAME) %>%
    mutate(Count = 1:length(NAME)) %>%
    filter(Count == 1) %>%
    select(-Count)
  
  saveRDS(lookup_method_id_dw_1, "Data/0110_lookup_method_id_dw_1.rds")
}

lookup_method_id_dw_1 <- readRDS("Data/0110_lookup_method_id_dw_1.rds")

check <- lookup_method_id_dw_1 %>%
  add_count(NAME) %>% 
  filter(n > 1)
if (nrow(check) > 0)
  stop("Dublettes in the names")
  

lookup_method_id_dw <- lookup_method_id_dw_1

# data
df_temporary <- df_nilu_03_sed_a_rest %>%
  select(-c(METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID)) %>%
  left_join(lookup_method_id_dw, by = c("NAME_modified" = "NAME"))

df_nilu_03_sed_b <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_sed_b_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_sed_b), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_sed_b_rest), "rows")

df_names_lacking_b <- df_nilu_03_sed_b_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_b), "names \n\n")
cat("Sum:", nrow(df_nilu_03_sed_b) + nrow(df_nilu_03_sed_b_rest), "rows")


if (F){
  writexl::write_xlsx(
    list(df_names_lacking_b, lookup_method_id_dw),
    "Data/0110_df_dryweight_names_lacking_2019.xlsx")
}

```

#### Check units  
```{r}

df_nilu_03_sed_b %>% 
  count(Unit, UNIT)

```


### Set 'c': Add final existing methods   

* Use '0110_dat_nivabase_nilu_methods.xlsx' to modify '0110_df_dryweight_names_lacking_b.xlsx'
    - adding columns NAME, METHOD_ID, UNIT, MATRIX, LABORATORY for existing methods where we have a match  
* Resulting excel: '0110_df_names_edited_dryweight.xlsx'
* Using a look-up table for the names  

```{r}


# data
df_temporary <- df_nilu_03_sed_b_rest %>%
  mutate(
    METHOD_ID = case_when(
      NAME_modified == "Dibromoaldrine" ~ 38726,
      NAME_modified == "M3T(Ph)" ~ 38750)
  )

df_nilu_03_sed_c <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_sed_c_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_sed_c), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_sed_c_rest), "rows")

df_names_lacking_c <- df_nilu_03_sed_c_rest %>%
  distinct(NAME_modified, Unit)

cat(" and", nrow(df_names_lacking_c), "names \n\n")
cat("Sum:", nrow(df_nilu_03_sed_c) + nrow(df_nilu_03_sed_c_rest), "rows")


```
#### Check units  
```{r}

df_nilu_03_sed_c %>% 
  count(Unit, UNIT)

```

### Add methods    


#### Make data for adding to METHOD_DEFINITIONS   
```{r}

cat("Check units of parameters that will be added: \n")
tab <- table(df_names_lacking_c$Unit)
tab
if (sum(is.na(df_names_lacking_c$Unit)) > 0)
  stop("There are data without units!")
unit_is_ng_p_g <- grepl("ng/g", df_names_lacking_c$Unit)
if (mean(unit_is_ng_p_g) < 1)
  stop("There are data that don't have ng/g unit")

df_methods_to_add_sed <- df_names_lacking_c %>%
  filter(!is.na(Unit)) %>%
  distinct(NAME_modified) %>%
  rename(NAME = NAME_modified) %>%
  as.data.frame()

df_methods_to_add_sed$UNIT <- "ng/g d.w."     # NOTE: rememebr 'd.w.' here
df_methods_to_add_sed$LABORATORY <- "NILU"
df_methods_to_add_sed$MATRIX <- "Sediment"
df_methods_to_add_sed$MATRIX_ID <- 2
df_methods_to_add_sed$CAS <- NA
df_methods_to_add_sed$METHOD_REF <- NA

# saveRDS(df_methods_to_add_sed, "Data/0110_df_methods_to_add_sed.rds")

```

#### Make SQLs    

PASTE INTO SQL DEVELOPER TO ADD THE RECORDS    

- Need NAME, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID  
Note to DHJ: use "SQL developer (latest version)" from desktop. Don't use the start menu.  
- remember `commit;` after running the insert sentences  

```{r}

sql_list <- 1:nrow(df_methods_to_add_sed) %>% 
  map_chr(make_sql_methods, data = df_methods_to_add_sed)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")  
writeLines(sql, "clipboard")  # copies SQLs to clipboard - go to SQL Developer and paste

cat("Number of SQLs: \n")
length(sql_list)  # 9


cat("\nSample of SQLs: \n")
sql_list[1:3]

```

### Get the records we just added   

- Also checks that the number of new records is the same as no. of SQLs  
- Remember to **commit** in SQL developer first  

```{r}

if (FALSE){

  library(niRvana)
  
  # day_for_adding_records <- substr(lubridate::now(tzone = "UTC"), 1, 10)
  day_for_adding_records <- "2023-02-14"
  
  sed_methods_added_to_database <- niRvana::get_nivabase_data(paste(
    "select NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, CAS, MATRIX_ID",
    "from NIVADATABASE.METHOD_DEFINITIONS",
    "where TRUNC(ENTERED_DATE) = TO_DATE(", sQuote(day_for_adding_records), ", 'yyyy-mm-dd')", 
    " and ENTERED_BY = 'DHJ'")
  )
  
  cat("Number of retrieved records: ")
  n_records2 <- nrow(sed_methods_added_to_database)
  n_records2
  
  write.table(sed_methods_added_to_database, "Data/0110_sed_methods_added_to_database.txt", 
              sep = "\t", row.names = FALSE)
  
}

sed_methods_added_to_database_1 <- read.table("Data/0110_sed_methods_added_to_database.txt", header = TRUE)


```

#### Add some extra, if needed  

```{r}

# If needed, somthing like this:
#
# lookup_extra1 <- structure(
#   list(
#     NAME = c("4-Nonylphenol", "4-tert-Octylphenol"), 
#     METHOD_ID = c(32390, 32454), UNIT = c("ng/g w.w.", "ng/g w.w."), LABORATORY = c("NILU", "NILU"), 
#     METHOD_REF = c("LC-QToF", "LC-QToF"), MATRIX = c("BIOTA", "BIOTA"), MATRIX_ID = c(1, 1)), 
#   class = "data.frame", row.names = c(NA, -2L)
# )

# sed_methods_added_to_database <- bind_rows(sed_methods_added_to_database_1, lookup_extra1)

sed_methods_added_to_database <- sed_methods_added_to_database_1

```


### Set 'd': Added methods are added to data  

- Based on the 'rest' from set b  
- Using NAME_modified   

```{r}

# data
df_temporary <- df_nilu_03_sed_c_rest %>%
  select(-c(METHOD_ID, UNIT, LABORATORY, MATRIX)) %>%
  left_join(sed_methods_added_to_database, by = c("NAME_modified" = "NAME"))

df_nilu_03_sed_d <- df_temporary %>%
  filter(!is.na(METHOD_ID))
df_nilu_03_sed_d_rest <- df_temporary %>%
  filter(is.na(METHOD_ID))

cat("METHOD_ID added for", nrow(df_nilu_03_sed_d), "rows by join using 'NAME_modified' \n")
cat("METHOD_ID still lacking for", nrow(df_nilu_03_sed_d_rest), "rows")

df_names_lacking_d <- df_nilu_03_sed_d_rest %>%
  distinct(NAME_orig, NAME_modified)

cat(" and", nrow(df_names_lacking_d), "names \n\n")
cat("Sum:", nrow(df_nilu_03_sed_d) + nrow(df_nilu_03_sed_d_rest), "rows")


if (F){
  writexl::write_xlsx(
    list(df_names_lacking_b, lookup_method_id_dw),
    "Data/0110_df_names_lacking_b.xlsx")
}

```

### Combine a, b, c and d   

```{r}

df_nilu_03_sed_02 <- bind_rows(
  df_nilu_03_sed_a,
  df_nilu_03_sed_b,
  df_nilu_03_sed_c
#  df_nilu_03_sed_d
) %>%
  rename(SLICE_ID = LABWARE_SLICEID_ID) %>%
  # Set MATRIX - see check of existing data in the next chunk
  mutate(MATRIX = "NS")

df_nilu_03_sed_02 <- df_nilu_03_sed_02 %>%
  rename(VALUE = Value,
         FLAG1 = Flag)

if (nrow(df_nilu_03_sed_01) != nrow(df_nilu_03_sed_02)){
  stop("Number of rows should be the same")
}

if (sum(is.na(df_nilu_03_sed_02$SLICE_ID)) > 0){
  stop("Some SLICE_ID are lacking!")
}

# check <- df_nilu_03_sed_02 %>%
#   filter(is.na(SLICE_ID))

```

### Check units  
```{r}

df_nilu_03_sed_02 %>%
  count(Unit, UNIT)

```


### Check existing sediment data (NIVA data)    
```{r}

df_check <- get_nivabase_selection(
  "*",
  "SEDIMENT_CHEMISTRY_VALUES",
  "SLICE_ID",
  unique(df_nilu_03_sed_02$SLICE_ID))

df_check_meth <- get_nivabase_selection(
  "METHOD_ID, NAME, UNIT, MATRIX",
  "METHOD_DEFINITIONS",
  "METHOD_ID",
  df_check$METHOD_ID
)

df_check <- df_check %>%
  left_join(df_check_meth, by = "METHOD_ID")

xtabs(~SLICE_ID, df_check)
  
# MATRIX = NS
# FRACTION_SIZE = NULL

```


### Add measurements to Nivabasen  

### Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS  
```{r}

# df_nilu_03_sed_02

# make_sql_sedimentchemistry_values 
#   expects olumn names
# SLICE_ID, METHOD_ID, MATRIX, VALUE, FLAG1

# Test
# make_sql_sedimentchemistry_values(1, df_nilu_03_sed_02)

sql_list <- 1:nrow(df_nilu_03_sed_02) %>% 
  map_chr(make_sql_sedimentchemistry_values, 
          data = df_nilu_03_sed_02)
length(sql_list) # 399

i <- 1:length(sql_list)
sql <- paste(sql_list[i], collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard-4096")   # copies SQLs to clipboard - go to SQL Developer and paste
                                    # "clipboard-1024" instead of "clipboard": increases avaliable
                                      #    for the clipboard
cat("Length of sql_list:", 
    length(sql_list), "\n\n")

cat("Two first and two last SQLs: \n\n")
head(sql_list, 2)
cat("-------------------------------------\n")
tail(sql_list, 2)

#
# See 'Urbanfjord_biota_measurements_5sql' in SQL Developer
# C:\Users\DHJ\AppData\Roaming\SQL Developer
#

```




## APPENDIX 1  

### Get IFE paraeters  

```{r}

# Getting the IFE parameters used for the last deliveries

if (FALSE){

  
  library(niRvana)
  
  # Get all IFE parameters  
  df_check <- get_nivabase_data(paste(
    "select NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
    "from NIVADATABASE.METHOD_DEFINITIONS", 
    "where lower(NAME) like '%delta%'and LABORATORY = 'IFE'")
  )
  # We know one IFE parameter (d13C), we get method ID from this  
  lookup_ife <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
    "METHOD_DEFINITIONS", 
    "NAME",
    "d13C", values_are_text = TRUE
  )
  # Get sample ID used for that parameter
  check1a <- get_nivabase_selection(
    "*", 
    "BIOTA_CHEMISTRY_VALUES", 
    "METHOD_ID",
    lookup_ife$METHOD_ID
  )
  # Get all measurements for those sample ID
  check1b <- get_nivabase_selection(
    "*", 
    "BIOTA_CHEMISTRY_VALUES", 
    "SAMPLE_ID",
    unique(check1a$SAMPLE_ID)
  )
  # Get all methods for those measurements
  check_meth <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, METHOD_REF, MATRIX, MATRIX_ID", 
    "METHOD_DEFINITIONS", 
    "METHOD_ID",
    unique(check1b$METHOD_ID)
  )
  
  # From the last table, we get the lacking paraeters:
  # "d15N", "W% C", "W% N", "C/N"
  

}


```

## APPENDIX 2


### Revised version of lookup_method_id, called 'lookup_method_id_2'  

```{r}



if (FALSE){
  
  library(niRvana)
  
  lookup_method_id_ww <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, MATRIX",
    "METHOD_DEFINITIONS", 
    "METHOD_ID", 
    lookup_methods_manual$METHOD_ID
  )
  
  all_names <- c(lookup_method_id_ww$NAME, unique(df_nilu_02$NAME_orig))
  sel <- nchar(all_names) > 30; sum(sel) 
  all_names <- all_names[!sel]
  
  lookup_method_id_perliter <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, MATRIX",
    "METHOD_DEFINITIONS", 
    "NAME", 
    all_names, values_are_text = TRUE, 
    extra_sql = "and UNIT like '%L%' and LABORATORY = 'NILU'"
  )
  
  lookup_method_id_dw <- get_nivabase_selection(
    "NAME, METHOD_ID, UNIT, LABORATORY, MATRIX",
    "METHOD_DEFINITIONS", 
    "NAME", 
    all_names, values_are_text = TRUE, 
    extra_sql = "and UNIT like '%d.w%' and LABORATORY = 'NILU'"
  )
    
  
  lookup_method_id_2 <- bind_rows(
      lookup_method_id %>% mutate(Unit_type = "used last year"), 
      lookup_method_id_ww %>% mutate(Unit_type = "ww"), 
      lookup_method_id_perliter %>% mutate(Unit_type = "perliter"), 
      lookup_method_id_dw %>% mutate(Unit_type = "dw")) %>%
    distinct(NAME, METHOD_ID, UNIT, LABORATORY, MATRIX, Unit_type) %>%
    filter(!is.na(LABORATORY) & UNIT != "NONE")
  
  # Check duplicates - a few cases  
  df_dupl <- lookup_method_id_2 %>%
    add_count(NAME, Unit_type) %>%
    filter(n > 1) %>%
    arrange(NAME, Unit_type)
  
  lookup_method_id_3 <- lookup_method_id_2 %>%
    arrange(NAME, METHOD_ID) %>%
    group_by(NAME, Unit_type) %>%
    mutate(no = seq_along(NAME)) %>% # xtabs(~no, .)
    filter(no == 1) %>%
    ungroup()

  # Write with tab as separator to avoid trouble with commas in names etc.  
  write.table(lookup_method_id_3, "Input_data/Lookup_files/lookup_method_id_3.txt",
              sep = "\t", row.names = FALSE)
  
  
}


```

## APPENDIX 3   

### Snippets  
```{r}

if (FALSE){
  
  library(niRvana)
  
  # Get all IFE parameters  
  df_check <- get_nivabase_data(paste(
    "select *", 
    "from NIVADATABASE.METHOD_DEFINITIONS", 
    "where NAME = 'C6H5N3'")
  )
  
  
}



```


## APPENDIX 4 - checking storm water + water treatment plant stations      

- For 3 stations (two with overvann/storm water: Alna 125 and Alna 136 + Bekkelaget WT), each physical
water sample is split in two samples for the lab: the particle fraction and the water fraction   
- Analytical results for both the water and sediment fractions are given in per-liter units   

- The "water tables" should have 3 samples (all with per liter, of course):  
    - ALN 125x (Alna)
    - ALN 136x (Alna)
    - BRA (Bekkelaget Renseanlegg)
- The "sediment tables" should have 4 samples:
    - Matrix sediment, unit = per liter: ALN 125xp (Alna)
    - Matrix sediment, unit = per liter: ALN 136xp (Alna)
    - Matrix sediment, unit = per liter: BRA (Bekkelaget Renseanlegg)
    - Matrix sediment, unit = per gram:  Cm21 (Cm21)  
- Results:
```
Water:
paste(STATION_CODE, STATION_NAME) 2017 2019 2020
      ALN 125x Alna                 1    1    1
      ALN 125xp Alna partikkel      0    0    1
      ALN 136x Alna                 1    1    1
      ALN 136xp Alna partikkel      0    0    1
      BRA Bekkelaget Renseanlegg    2    2    2
Sediment:
paste(STATION_CODE, STATION_NAME) 2017 2019 2020
      ALN 125xp Alna partikkel      1    2    0
      ALN 136xp Alna partikkel      1    2    0
      BRA Bekkelaget Renseanlegg    2    2    2
      Cm21 Cm21                     0    1    1
Sediment unit 2019:
paste(STATION_CODE, STATION_NAME) NG_P_G NG_P_L
       ALN 125xp Alna partikkel        1      1
       ALN 136xp Alna partikkel        1      1
       BRA Bekkelaget Renseanlegg      2      0
       Cm21 Cm21                       1      0
```
- For Alna:   
    - Separate station codes and STATION_IDs for water and sediment fractiopns
    - 2017 looks OK, but sediment has been given unit "per gram" (not shown above)    
    - 2019: each sediment fraction value has stored two times unit "per gram" and "per liter" 
    (for the same measurements, e.g. for PFOS at 125xp: 5.8 NG_P_G	and 5.8 NG_P_L)          
    - 2020: all samples have been put in the water tables   
- For Bekkelaget: 
    - Only one STATION_ID 
    - 2017 looks OK, but sediment has been given unit "per gram" (not shown above)    
    - 2019: not really sure what happened here, but some doubling of data also here  
    - 2020: not checked yet
- Cm21:
    - A "true" sediment station from the bottom of the fjord. All data seem ok.  

### 1 Where does data from Labware end up? water   

```{r}

use_nivabase <- TRUE  

if (use_nivabase){
  
  library(niRvana)
  
  # Get PFOSA   
  df_methods <- get_nivabase_data(paste(
    "select *", 
    "from NIVADATABASE.METHOD_DEFINITIONS", 
    "where NAME like '%PFOSA%' and ENTERED_BY = 'LABWARE'")
  )
  # NOTE: 34153: MATRIX = sediment but UNIT = NG_P_L

  df_wat_meas <- get_nivabase_selection(
    "WATER_SAMPLE_ID, METHOD_ID, VALUE, FLAG1",
    "WATER_CHEMISTRY_VALUES",
    "METHOD_ID",
    df_methods$METHOD_ID
  ) %>%
    left_join(df_methods %>% select(METHOD_ID, NAME, UNIT, MATRIX))
  
  df_wat_samples <- get_nivabase_selection(
    "STATION_ID, WATER_SAMPLE_ID, SAMPLE_DATE, DEPTH1, DEPTH2, PRE_TREATMENT_ID, SAMPLING_METHOD_ID",
    "WATER_SAMPLES",
    "WATER_SAMPLE_ID",
    df_wat_meas$WATER_SAMPLE_ID
  )
    
  df_stations_wat <- get_nivabase_selection(
    "STATION_ID, STATION_CODE, STATION_NAME, PROJECT_ID",
    "PROJECTS_STATIONS",
    "STATION_ID",
    c(df_wat_samples$STATION_ID, 73472)  # 73472 = code "ALNA vann" for 2021
  )
  
  df_proj <- get_nivabase_selection(
    "PROJECT_ID, PROJECT_NAME",
    "PROJECTS",
    "PROJECT_ID",
    df_stations_wat$PROJECT_ID
  )
  
  df_wat <- df_wat_meas %>%
    left_join(df_wat_samples) %>%
    left_join(df_stations_wat) %>%
    left_join(df_proj) %>%
    mutate(MYEAR = year(SAMPLE_DATE))
  
  # xtabs(~paste(STATION_CODE, STATION_NAME) + PROJECT_NAME, df_wat)
  # xtabs(~PROJECT_NAME + year(SAMPLE_DATE), df_wat)
  # Also
  xtabs(~paste(STATION_CODE, STATION_NAME) + year(SAMPLE_DATE), 
        df_wat %>% filter(PROJECT_NAME == "Urban fjord"))
  
  # All are NG_P_L
  # In 2020, "ALN 125xp Alna partikkel" and "ALN 136xp Alna partikkel" ended up in water  
  
  xtabs(~UNIT + MYEAR, 
        df_wat %>% filter(PROJECT_NAME == "Urban fjord"))
  xtabs(~paste(STATION_CODE, STATION_NAME) + MYEAR, 
        df_wat %>% filter(PROJECT_NAME == "Urban fjord"))
  
  #paste(STATION_CODE, STATION_NAME) 2017 2019 2020
        # ALN 125x Alna                 1    1    1
        # ALN 125xp Alna partikkel      0    0    1
        # ALN 136x Alna                 1    1    1
        # ALN 136xp Alna partikkel      0    0    1
        # BRA Bekkelaget Renseanlegg    2    2    2
       

}





```
### 2 Where does data from Labware end up? sediment         
```{r}

if (use_nivabase){
  
  library(niRvana)
  
  df_sed_meas <- get_nivabase_selection(
    "SLICE_ID, METHOD_ID, MATRIX, VALUE, FLAG1",
    "SEDIMENT_CHEMISTRY_VALUES",
    "METHOD_ID",
    df_methods$METHOD_ID
  ) %>%
    rename(MATRIX_meas = MATRIX) %>%
    left_join(df_methods %>% select(METHOD_ID, NAME, UNIT, MATRIX))
  
  df_sed_slices <- get_nivabase_selection(
    "SAMPLE_ID, SLICE_ID, DEPTH1, DEPTH2",
    "SEDIMENT_SLICES",
    "SLICE_ID",
    df_sed_meas$SLICE_ID
  )
  
  df_sed_samples <- get_nivabase_selection(
    "STATION_ID, SAMPLE_ID, SAMPLE_DATE",
    "SEDIMENT_SAMPLES",
    "SAMPLE_ID",
    df_sed_slices$SAMPLE_ID
  )
  
  df_stations_sed <- get_nivabase_selection(
    "STATION_ID, STATION_CODE, STATION_NAME, PROJECT_ID",
    "PROJECTS_STATIONS",
    "STATION_ID",
    df_sed_samples$STATION_ID
  )
  
  df_sed <- df_sed_meas %>%
    left_join(df_sed_slices) %>%
    left_join(df_sed_samples) %>%
    left_join(df_stations_sed) %>%
    left_join(df_proj) %>%
    mutate(MYEAR = year(SAMPLE_DATE)) 
  
  xtabs(~UNIT + MYEAR, 
        df_sed %>% filter(PROJECT_NAME == "Urban fjord"))
  #
  # Per liter only used in 2019
  #
  # UNIT     2017 2019 2020
  #   NG_P_G    4    5    3
  #   NG_P_L    0    2    0
  
  xtabs(~paste(STATION_CODE, STATION_NAME) + MYEAR, 
        df_sed %>% filter(PROJECT_NAME == "Urban fjord"))
  
  # Overvann 'partikkel' not used in 2020   
  # paste(STATION_CODE, STATION_NAME) 2017 2019 2020
  #        ALN 125xp Alna partikkel      1    2    0
  #        ALN 136xp Alna partikkel      1    2    0
  #        BRA Bekkelaget Renseanlegg    2    2    2
  #        Cm21 Cm21                     0    1    1
  

  df_2019_sed <- df_sed %>% 
    filter(PROJECT_NAME == "Urban fjord" & MYEAR == 2019)
  xtabs(~paste(STATION_CODE, STATION_NAME) + UNIT, df_2019_sed)
  
  # paste(STATION_CODE, STATION_NAME) NG_P_G NG_P_L
  #        ALN 125xp Alna partikkel        1      1
  #        ALN 136xp Alna partikkel        1      1
  #        BRA Bekkelaget Renseanlegg      2      0
  #        Cm21 Cm21                       1      0
  

}


```

### 3 All water data from a given year   

- As it seems that 2019 is the only year where we have used per-liter  
- BUT even in 2019, the same number has been submitted both with per gram and per liter    


```{r}

if (use_nivabase){
  
  library(niRvana)
  
  station_codes <- c("ALN 125x", "ALN 125xp", "ALNA vann")
  # station_codes <- c("BRA")
  yr <- 2019
  
  wat_id <- df_stations_wat_sel <- df_stations_wat %>%
    filter(STATION_CODE %in% station_codes) %>%
    pull(STATION_ID)
  
  df_wat_samples_sel <- df_wat_samples %>%
    filter(STATION_ID %in% wat_id & year(SAMPLE_DATE) == yr)
  df_wat_samples_sel2 <- get_nivabase_selection(
    "STATION_ID, WATER_SAMPLE_ID, SAMPLE_DATE, DEPTH1, DEPTH2, PRE_TREATMENT_ID, SAMPLING_METHOD_ID",
    "WATER_SAMPLES",
    "STATION_ID",
    wat_id, extra_sql = paste(" and year(SAMPLE_DATE) =", yr)
  )

    

  df_wat_meas_sel <- get_nivabase_selection(
    "WATER_SAMPLE_ID, METHOD_ID, VALUE, FLAG1",
    "WATER_CHEMISTRY_VALUES",
    "WATER_SAMPLE_ID",
    df_wat_samples_sel$WATER_SAMPLE_ID
  )
  
  df_wat_meas_sel <- get_nivabase_selection(
    "WATER_SAMPLE_ID, METHOD_ID, VALUE, FLAG1",
    "WATER_CHEMISTRY_VALUES",
    "WATER_SAMPLE_ID",
    df_wat_samples_sel$WATER_SAMPLE_ID
  )
  
  df_wat_methods_sel <- get_nivabase_selection(
    "METHOD_ID, NAME, UNIT, MATRIX",
    # "*",
    "METHOD_DEFINITIONS",
    "METHOD_ID",
    df_wat_meas_sel$METHOD_ID
  )

  df_wat <- df_wat_meas_sel %>%
    left_join(df_wat_methods_sel) %>%
    left_join(df_wat_samples_sel) %>%
    left_join(df_stations_wat) %>%
    mutate(MYEAR = year(SAMPLE_DATE))
  
  df_wat %>%
    filter(NAME %in% c("Octocrylen", "Perfluoroktylsulfonat (PFOS)")) %>%
    select(-c(DEPTH1, DEPTH2, PRE_TREATMENT_ID, SAMPLING_METHOD_ID)) %>%
    arrange(NAME, UNIT)  

}

```

### 4 All sediment data from a given year   

- As it seems that 2019 is the only year where we have used per-liter  
- BUT even in 2019, the same number has been submitted both with per gram and per liter    


```{r}


if (use_nivabase){
  
  library(niRvana)
  
  station_codes <- c("ALN 125xp", "ALNA Vann")
  # station_codes <- c("BRA")
  # station_codes <- c("Cm21")
  yr <- 2020
  
  sed_id <- df_stations_sed_sel <- df_stations_sed %>%
    filter(STATION_CODE %in% station_codes) %>%
    pull(STATION_ID)
  
  df_sed_samples_sel <- df_sed_samples %>%
    filter(STATION_ID %in% sed_id & year(SAMPLE_DATE) == yr)
  
  df_sed_slices_sel <- df_sed_slices %>%
    filter(SAMPLE_ID %in% df_sed_samples_sel$SAMPLE_ID)
  
  df_sed_meas_sel <- get_nivabase_selection(
    "SLICE_ID, METHOD_ID, VALUE, FLAG1",
    "SEDIMENT_CHEMISTRY_VALUES",
    "SLICE_ID",
    df_sed_slices_sel$SLICE_ID
  )
  
  df_sed_methods_sel <- get_nivabase_selection(
    "METHOD_ID, NAME, UNIT, MATRIX",
    "METHOD_DEFINITIONS",
    "METHOD_ID",
    df_sed_meas_sel$METHOD_ID
  )
  
  df_sed <- df_sed_meas_sel %>%
    left_join(df_sed_methods_sel) %>%
    left_join(df_sed_slices_sel) %>%
    left_join(df_sed_samples_sel) %>%
    left_join(df_stations_sed) %>%
    mutate(MYEAR = year(SAMPLE_DATE))
  
  df_sed %>%
    filter(NAME %in% c("Octocrylen", "Perfluoroktylsulfonat (PFOS)")) %>%
    select(-c(DEPTH1, DEPTH2)) %>%
    arrange(NAME, UNIT)

}



```

### 5 All sediment data based on station + year   

- As it seems that 2019 is the only year where we have used per-liter  
- BUT even in 2019, the same number has been submitted both with per gram and per liter    


```{r}


if (use_nivabase){
  
  library(niRvana)
  # 8551
  
  # 8551 69644 BRA Bekkelaget Renseanlegg-- 8551 67067 Cm21 Cm21-- 8551 67068 Bq41 Bekkelaget
  
  df_stations_sed <- get_nivabase_selection(
    "STATION_ID, STATION_CODE, STATION_NAME, PROJECT_ID",
    "PROJECTS_STATIONS",
    "STATION_ID",
    c(69644, 67067, 67068), # extra_sql = "and ",
  )
  
  # OR:
  df_stations_sed <- get_nivabase_selection(
    "STATION_ID, STATION_CODE, STATION_NAME, PROJECT_ID",
    "PROJECTS_STATIONS",
    "STATION_CODE",
    c("Cm21"), values_are_text = TRUE
  )
  
  df_sed_samples_all <- get_nivabase_selection(
    "SAMPLE_ID, STATION_ID, SAMPLE_DATE",
    "SEDIMENT_SAMPLES",
    "STATION_ID",
    67067
  )
  df_sed_samples <- df_sed_samples_all %>%
    filter(year(SAMPLE_DATE) == 2019)
  
   df_sed_slices <- get_nivabase_selection(
    "SAMPLE_ID, SLICE_ID",
    "SEDIMENT_SLICES",
    "SAMPLE_ID",
    df_sed_samples$SAMPLE_ID
  )
  
   df_sed_slices$SLICE_ID 

}



```

### 6 All sediment data for given slice ID   

```{r}

if (use_nivabase){
    
  library(niRvana)
  ids <- unique(df_nilu_03_sed_01$LABWARE_SLICEID_ID)
  
  lookup_sampleid_sed$LABWARE_SLICEID_ID

  df_sed_meas <- get_nivabase_selection(
    "SLICE_ID, METHOD_ID, VALUE, FLAG1",
    "SEDIMENT_CHEMISTRY_VALUES",
    "SLICE_ID",
    ids
  )
  
  df_sed_methods <- get_nivabase_selection(
    "METHOD_ID, NAME, UNIT, MATRIX",
    "METHOD_DEFINITIONS",
    "METHOD_ID",
    df_sed_meas$METHOD_ID
  )
  
   df_sed_slices <- get_nivabase_selection(
    "SAMPLE_ID, SLICE_ID",
    "SEDIMENT_SLICES",
    "SLICE_ID",
    ids
  )
   
  df_sed_samples <- get_nivabase_selection(
    "SAMPLE_ID, STATION_ID, SAMPLE_DATE",
    "SEDIMENT_SAMPLES",
    "SAMPLE_ID",
    unique(df_sed_slices$SAMPLE_ID)
  )
  
  df_stations_sed <- get_nivabase_selection(
    "STATION_ID, STATION_CODE, STATION_NAME",
    "PROJECTS_STATIONS",
    "STATION_ID",
    unique(df_sed_samples$STATION_ID)
  )
  
  df_sed <- df_sed_meas %>%
    left_join(df_sed_methods) %>%
    left_join(df_sed_slices) %>%
    left_join(df_sed_samples) %>%
    left_join(df_stations_sed) %>%
    mutate(MYEAR = year(SAMPLE_DATE))
    
  xtabs(~MYEAR + STATION_CODE, df_sed)  
  xtabs(~NAME + STATION_CODE, df_sed)  

   
}

   
   
```



### LIMS  

```{r}

if (use_nivabase){
  
  library(niRvana)
  
  # get_nivabase_data("select * from NIVADATABASE.LABWARE_IMPORT where rownum < 100")
  
  df_lims_alna <- get_nivabase_selection(
    columns = "*", 
    table = "LABWARE_CHECK_SAMPLE", 
    selection_column = "AQUAMONITOR_CODE", 
    selection_values = c("125x", "125xp", "136x", "136xp"), values_are_text = T)

  df_limssamp_aru <- get_nivabase_selection(
    columns = "*", 
    table = "LABWARE_CHECK_SAMPLE", 
    selection_column = "CUSTOMER", 
    selection_values = "ARU", values_are_text = T)
  table(df_limssamp_aru$PROSJEKT, year(df_limssamp_aru$SAMPLED_DATE))
  
  df_limssamp_alna <- df_limssamp_aru %>%
    filter(grepl("urban", PROSJEKT, ignore.case = TRUE)) %>%
    filter(grepl("aln", DESCRIPTION, ignore.case = TRUE)) %>%
    mutate(MYEAR = year(SAMPLED_DATE), .before = 1)
  
  table(df_limssamp_alna$DESCRIPTION, df_limssamp_alna$MYEAR)


  yr <- 2017
  yr <- 2018
  yr <- 2019
  yr <- 2021
  df_limssamp_alna %>% filter(MYEAR == yr) %>%
    #select(MYEAR, TEXT_ID, SAMPLE_TYPE, SAMPLED_DATE, DESCRIPTION, AQUAMONITOR_ID, AQUAMONITOR_CODE, AQUAMONITOR_NAME) %>%
    View(paste("Alna", yr))
  
  #
  # Data
  #
  df_limsdata_alna <- get_nivabase_selection(
    columns = "*", 
    table = "LABWARE_IMPORT", 
    selection_column = "ANALYSEOPPDRAG", 
    selection_values = df_limssamp_alna$ANALYSEOPPDRAG, values_are_text = T) %>%
    filter(grepl("aln", DESCRIPTION, ignore.case = TRUE))

  df_limsdata_alna <- df_limsdata_alna %>% 
    filter(DESCRIPTION %in% df_limssamp_alna$DESCRIPTION) %>%
    mutate(MYEAR = year(SAMPLED_DATE), .before = 1)
  
  yr <- 2019
  df_limsdata_alna %>%
    filter(MYEAR == yr) %>% 
    filter(REPORTED_NAME == "Perfluoroktylsulfonat (PFOS)",
           grepl("125", AQUAMONITOR_CODE)) %>%
    select(PROSJEKT, TEXT_ID, SAMPLE_TYPE, SAMPLED_DATE, DESCRIPTION, AQUAMONITOR_ID, AQUAMONITOR_CODE, AQUAMONITOR_NAME, REPORTED_NAME,FORMATTED_ENTRY, NUMERIC_ENTRY, UNITS, AQUAMONITOR_UNIT, PARAM_I_AQUAMONITOR) %>%
    View(paste("LIMS data 125x", yr))

  df_lims <- get_nivabase_selection(
    columns = "*", 
    table = "LABWARE_CHECK_SAMPLE", 
    selection_column = "CUSTOMER", 
    selection_values = "ARU", values_are_text = T)

  
  	


  df_check1 <- get_nivabase_selection(
    columns = "*", 
    table = "LABWARE_CHECK_SAMPLE", selection_column = "TEXT_ID", 
    selection_values = c("NR-2021-07936", "NR-2021-07939"), values_are_text = T)
  # DESCRIPTION: 
  # BRA Bekkelaget - Av (vannfase)  
  # BRA Bekkelaget - Ap (partikkelfase)
  # 07936 = vannfase
  # 07939 = partikkelfase  
  
  df_check2 <- get_nivabase_selection(
    columns = "*", 
    table = "LABWARE_IMPORT", 
    selection_column = "TEXT_ID", 
    selection_values = c("NR-2021-07936","NR-2021-07939"), values_are_text = T)

  df_check2 <- get_nivabase_selection(
  "PROSJEKT, TEXT_ID, SAMPLE_TYPE, SAMPLED_DATE, DESCRIPTION, AQUAMONITOR_ID, AQUAMONITOR_CODE, AQUAMONITOR_NAME, REPORTED_NAME,FORMATTED_ENTRY, NUMERIC_ENTRY, UNITS, AQUAMONITOR_UNIT, PARAM_I_AQUAMONITOR", 
  table = "LABWARE_IMPORT", 
  selection_column = "TEXT_ID", 
  selection_values = c("NR-2021-07936","NR-2021-07939"), values_are_text = T)

}



  
}


```


### 2021  
```{r}

df_stations_wat <- get_nivabase_selection(
  "STATION_ID, STATION_CODE, STATION_NAME, PROJECT_ID",
  "PROJECTS_STATIONS",
  "STATION_ID",
  73472  # 73472 = code "ALNA vann" for 2021
)


```

