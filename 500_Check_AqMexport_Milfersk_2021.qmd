---
title: "500_Check_AqMexport_Milfersk_2021"
format: html
---


## 1. Setup  

### Settings  

```{r}

string_saved_data <- "Milfersk_2021"

```

### Packages and scripts    

```{r, results='hide', warning=FALSE, message=FALSE}

library(niRvana)
library(dplyr)
library(purrr)
library(lubridate)
library(readxl)
library(ggplot2)
library(tidyr)
# library(fuzzyjoin)   # regex_full_join

source("../Milkys/991_Vannmiljo_snippets_functions.R")
source("../Milkys/992_Vannmiljo_Urban_fjord_functions.R")
# source("../Milkys/994_Industry_data_functions.R")         # for add_coordinates()
source("0001_Functions_sql_and_more.R")

knitr::opts_chunk$set(results = 'hold')

```

### Codes  

```{r}

lookup_medium <- read_excel("Data_from_Vannmiljo/Codes/Vannmiljø_medium_2023-06-23.xlsx")
lookup_samplingmethods <- read_excel("Data_from_Vannmiljo/Codes/Vannmiljø_prøvetakingsmetoder_2023-06-23.xlsx")

```


## 2. Biota and sediments  

### Read file   

```{r}

fn <- "Data_to_Vannmiljo/Milfersk_2021_gwme0lf.xlsx"
df_stations <- read_excel(fn, sheet = "Vannlokaliteter")

dat_raw <- read_excel(fn, sheet = "Vannregistreringer")

dat <- dat_raw %>%
  mutate(
    time = ymd(Tid_provetak),
    year = year(time)) %>%
  left_join(
    lookup_medium %>% select(MediumID, Name) %>% rename(Medium_name = Name), 
    by = c("Medium_id" = "MediumID")) %>%
  left_join(
    lookup_samplingmethods %>% select(SamplingMethodID, Name) %>% rename(Sampling_name = Name), 
    by = c("Provetakmetode_id" = "SamplingMethodID")) %>%
  left_join(
    df_stations %>% select(Kilde_id, Navn) %>% rename(Station_name = Navn), 
    by = c("Vannlok_kode" = "Kilde_id"))
  

```

### Tables   

```{r}

# xtabs(~Vannlok_kode + Medium_id, dat)
# xtabs(~Station_name + Medium_name, dat)

dat %>%
  count(Station_name, Medium_name) %>%
  knitr::kable()

dat %>%
  count(Station_name, Medium_name, Sampling_name) %>%
  knitr::kable()

```

## 3. Fix  

### Water sample with particle and water phase   

* Where do we have such water samples?  
    - For each of 2 samples of WWTP HIAS ('Avløpsvann og avløpsslam')   
    - For each of 2 samples of storm water ('Hamar overvann')    
* Example shown below for WWTP HIAS, with Hg as example    
    - also see top row in 'All_results MILFERSK2021.xlsx' in 'Input_data\2021'    

#### In Nivabase  

* Particle fraction given with '-R'  

```{r}

library(niRvana)
source("../Milkys/991_Vannmiljo_snippets_functions.R")
source("../Milkys/992_Vannmiljo_Urban_fjord_functions.R")
source("../Milkys/994_Industry_data_functions.R")         # for add_coordinates()
df_stations <- get_stations_from_project("MILFERSK 2021-2025", exact = TRUE)
df_samples_water <- get_nivabase_selection(
  "*", "WATER_SAMPLES",
  "STATION_ID", df_stations$STATION_ID)
dat_nb_water <- get_water_chemistry_from_stations(unique(df_samples_water$STATION_ID), 2017:2021)

dat_nb_water %>%
  filter(NAME %in% c("Hg", "Hg-P"),
         STATION_CODE == "HIAS") %>%
  select(WATER_SAMPLE_ID:SAMPLE_DATE, -METHOD_ID, VALUE_ID)

```

#### In export file  

```{r}

dat %>%
  filter(Parameter_id %in% "HG",
         Station_name == "Avløpsvann og avløpsslam",
         Medium_name == "Avløpsvann renset") %>%
  select(ID_lokal, Parameter_id, Medium_id, Medium_name, Provetakmetode_id, Tid_provetak, Verdi)

```








